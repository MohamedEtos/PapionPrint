$(document).ready(function(){$("#data-copies, #data-height, #data-price, #data-pic-copies, #data-machine, #data-pass").on("input change",function(){var a=parseFloat($("#data-copies").val())||0,e=parseFloat($("#data-height").val())||0,s=$("#data-machine").val(),t=$("#data-pass").val();parseFloat($("#data-price").val()),console.log("Machine/Pass changed");var s=$("#data-machine").val(),t=$("#data-pass").val();if(console.log("Machine ID:",s,"Pass:",t),s&&window.papionInvData&&window.papionInvData.machines){var n=window.papionInvData.machines.find(u=>u.id==s);if(console.log("Found Machine:",n),n){var r=0;t==4?r=parseFloat(n.price_4_pass):t==6?r=parseFloat(n.price_6_pass):r=parseFloat(n.price_1_pass),console.log("New Price:",r),r>0&&$("#data-price").val(r).trigger("change")}}else console.warn("Machine Data or ID missing",window.papionInvData);var i=a*e;$("#data-meters").val(i/100);var o=i*r;$("#data-total").val(o.toFixed(2));var d=parseFloat($("#data-pic-copies").val())||0,b=a*d,C=0;d>0&&(C=e/100/d*r),$("#data-price-pic").text(C.toFixed(2)),$("#data-total-pic").text(b),a>0&&e>0?$("#data-meters").prop("disabled",!0):$("#data-meters").prop("disabled",!1)}),$("#data-machine").on("change",function(){var a=$(this).find("option:selected").text().toLowerCase();a.includes("dtf")?($("#data-width").val(58),$("#data-pass").val(4).prop("disabled",!1)):a.includes("sublimation")?($("#data-width").val(150),$("#data-pass").val(1).prop("disabled",!0)):$("#data-pass").prop("disabled",!1)});var g=null;function F(){$("#data-customer, #data-customer-view, #data-machine, #data-height, #data-width, #data-copies, #data-pic-copies, #data-pass, #data-meters, #data-price, #data-notes, #data-fabric-type").val(""),$("#data-status").val("waiting"),$("#data-pass").val("1"),h=[],typeof p<"u"&&p&&p.removeAllFiles(),g=null,$(".new-data-title h4").text("اضافه اذن تشغيل"),$("#saveDataBtn").text("Add Data")}Dropzone.autoDiscover=!1;var h=[];Dropzone.instances.length>0&&Dropzone.instances.forEach(a=>a.destroy());try{var p=new Dropzone("#dataListUpload",{url:"/printers/upload-image",paramName:"file",maxFiles:10,acceptedFiles:".jpg,.jpeg,.png,.gif,.tiff,.tif,.webp",addRemoveLinks:!0,resizeHeight:110,resizeMimeType:"image/webp",resizeQuality:.9,headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},success:function(a,e){a.serverFileName=e.path,h.push(e.path),console.log("Images uploaded:",h),toastr.success("Image uploaded successfully")},removedfile:function(a){a.previewElement!=null&&a.previewElement.parentNode!=null&&a.previewElement.parentNode.removeChild(a.previewElement);var e=a.serverFileName;if(e){var s=h.indexOf(e);s!==-1&&(h.splice(s,1),console.log("Image removed. Remaining:",h))}return _updateMaxFilesReachedClass()},error:function(a,e){toastr.error("Upload failed:",e.message)}})}catch(a){toastr.error("Dropzone init warning:",a)}document.onpaste=function(a){for(var e=(a.clipboardData||a.originalEvent.clipboardData).items,s=0;s<e.length;s++){var t=e[s];t.kind==="file"&&p.addFile(t.getAsFile())}},$(document).on("click",".action-edit",function(a){a.stopPropagation();var e=$(this).closest("tr"),s=e.find(".order_id").val();s&&$.ajax({url:"/printers/"+s,type:"GET",success:function(t){$("#data-customer-view").val(t.customers?t.customers.name:""),$("#data-machine").val(t.machineId),$("#data-height").val(t.fileHeight),$("#data-width").val(t.fileWidth),$("#data-copies").val(t.fileCopies),$("#data-pic-copies").val(t.picInCopies),$("#data-fabric-type").val(t.fabric_type),$("#data-pass").val(t.pass),$("#data-meters").val(t.meters),$("#data-status").val(t.status),t.printingprices&&$("#data-price").val(t.printingprices.totalPrice),$("#data-notes").val(t.notes),$("#data-price-pic").text(t.manufacturing_cost||0),h=[],typeof p<"u"&&p&&(p.removeAllFiles(!0),t.orders_imgs&&t.orders_imgs.length>0&&t.orders_imgs.forEach(function(o){var d={name:"Image",size:12345,serverFileName:o.path};p.emit("addedfile",d),p.emit("thumbnail",d,"/storage/"+o.path),p.emit("complete",d),p.files.push(d),h.push(o.path)}));var n=parseFloat($("#data-copies").val())||0,r=parseFloat($("#data-pic-copies").val())||0,i=n*r;$("#data-total-pic").text(i),g=t.id,$(".new-data-title h4").text("تعديل البيانات"),$("#saveDataBtn").text("حفظ التعديلات"),$(".add-new-data").addClass("show"),$(".overlay-bg").addClass("show")},error:function(t){console.error("Error fetching order:",t),toastr.error("Could not fetch order details.","Error")}})}),$(document).on("click",".action-delete",function(a){a.stopPropagation();var e=$(this).closest("td").parent("tr"),s=e.find(".order_id").val();if(console.log(s),!s){e.fadeOut();return}Swal.fire({title:"هل انت متاكد?",text:"لن تتمكن من التراجع عن هذا!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"نعم، احذفه!",confirmButtonClass:"btn btn-primary",cancelButtonClass:"btn btn-danger ml-1",buttonsStyling:!1}).then(function(t){t.value&&$.ajax({url:"/printers/delete/"+s,type:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content")},success:function(n){console.log("Order deleted:",n),e.fadeOut(function(){$(this).remove()}),Swal.fire({type:"success",title:"تم الحذف!",showConfirmButton:!1,timer:1500,buttonsStyling:!1,confirmButtonClass:"btn btn-primary"})},error:function(n){console.error("Error deleting order:",n),Swal.fire({title:"Error!",text:"Error deleting order. Please try again.",type:"error",confirmButtonClass:"btn btn-primary",buttonsStyling:!1})}})})}),$(".hide-data-sidebar, .cancel-data-btn, .overlay-bg").on("click",function(a){a.stopPropagation(),$(".add-new-data").removeClass("show"),$(".overlay-bg").removeClass("show"),F()}),$("#saveDataBtn").on("click",function(a){a.preventDefault(),console.log("Save/Update Data Button Clicked");var e=$("#data-customer-view").val(),s=$("#data-machine").val(),t=$("#data-height").val(),n=$("#data-width").val(),r=$("#data-copies").val(),i=$("#data-pic-copies").val(),o=$("#data-pass").val(),d=$("#data-meters").val(),b=$("#data-status").val(),C=$("#data-fabric-type").val(),u=$("#data-price").val();$("#data-fabric-type").val();var f=$("#data-notes").val(),v="/printers/store",m="POST",y=parseFloat($("#data-price-pic").text())||0,k={customerId:e,machineId:s,fileHeight:t,fileWidth:n,fileCopies:r,picInCopies:i,pass:o,meters:d,status:b,price:u,fabric_type:C,notes:f,manufacturing_cost:y,image_paths:h,_token:$('meta[name="csrf-token"]').attr("content")};g&&(v="/printers/"+g,k._method="PUT",k.auto_advance_status=!0),$.ajax({url:v,type:m,data:k,success:function(c){try{console.log("Order saved/updated:",c);var I=g?"Order Updated Successfully!":"Order Added Successfully!";if(toastr.success(I,"تمت العملية بنجاح"),!c||!c.order){console.warn("Response missing 'order' object:",c);return}var l=c.order,x=l.customers?l.customers.name:"Unknown",B=l.machines?l.machines.name:"Unknown",D=l.printingprices?l.printingprices.pricePerMeter:"",_=l.orders_imgs&&l.orders_imgs.length>0?"/storage/"+l.orders_imgs[0].path:"/core/images/elements/apple-watch.png";if(g){var w=$('input.order_id[value="'+g+'"]').closest("tr");if(w.length){w.find(".product-img img").attr("src",_),w.find(".product-name").text(x);var E=w.find("td").eq(3);E.text(B+" "+l.pass+" pass");var P=w.find("td").eq(4);P.html("<b>"+l.meters+"</b>"),w.find(".chip-text").text(l.status),w.find(".chip").removeClass("chip-success chip-warning").addClass(l.status=="انتهت الطباعة"?"chip-success":"chip-info"),w.find("td:eq(6)").text(D)}}else{var T=`
                        <tr>
                            <td></td>
                            <td class="product-img">
                                <input type="hidden" class="order_id" value="${l.id}">
                                <img src="${_}" alt="Img placeholder">
                            </td>
                            <td class="product-name">${x}</td>
                            <td class="product-category">${B} ${l.pass} pass</td>
                            <td class="product-category"><b>${l.meters}</b></td>
                            <td>
                                <div class="chip chip-${l.status=="انتهت الطباعة"?"success":"info"}">
                                    <div class="chip-body status-toggle" style="cursor: pointer">
                                        <div class="chip-text">${l.status}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="product-price" title="Just now">الآن</td>
                            <td class="product-action">
                                <span class=" hover_action action-edit "><i class="feather icon-edit"></i></span>
                                <span class=" hover_action action-delete text-danger " ><i class="feather icon-trash"></i></span>
                            </td>
                        </tr>
                    `;$("table.data-thumb-view tbody").append(T)}}catch(O){console.error("Error updating UI:",O),toastr.warning("Order saved, but UI update encountered an issue. Please refresh.","Warning")}finally{$(".add-new-data").removeClass("show"),$(".overlay-bg").removeClass("show"),F()}},error:function(c){if(console.error("Error processing order:",c),c.status===422){var I=c.responseJSON.errors;$.each(I,function(l,x){toastr.error(x[0],"خطا")})}else toastr.error("Error processing order. Please try again.","خطا")}})}),$(document).on("click",".status-toggle",function(a){a.stopPropagation();var e=$(this),s=e.closest("tr"),t=s.find(".order_id").val(),n=e.find(".chip-text"),r=n.text().trim();if(r==="انتهت الطباعة"){s.fadeOut();return}if(t){if(r==="بانتظار اجراء"||r==="بانتظار اجراء"){a.preventDefault(),$.ajax({url:"/printers/"+t,type:"GET",success:function(i){$("#data-customer-view").val(i.customers?i.customers.name:""),$("#data-machine").val(i.machineId),$("#data-height").val(i.fileHeight),$("#data-width").val(i.fileWidth),$("#data-copies").val(i.fileCopies),$("#data-pic-copies").val(i.picInCopies),$("#data-pass").val(i.pass),$("#data-meters").val(i.meters),$("#data-fabric-type").val(i.fabric_type),$("#data-status").val(i.status),i.printingprices&&$("#data-price").val(i.printingprices.totalPrice),$("#data-notes").val(i.notes),g=i.id,$(".new-data-title h4").text("تحديث الطلب وبدات الطباعة"),$("#saveDataBtn").text("تحديث وبدء"),$(".add-new-data").addClass("show"),$(".overlay-bg").addClass("show")},error:function(i){console.error("Error fetching order:",i),toastr.error("Could not fetch order details.","Error")}});return}$.ajax({url:"/printers/update-status/"+t,type:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content")},success:function(i){n.text(i.status),Swal.fire({title:" تحديث الحالة :"+i.status,text:"Status updated to "+i.status,type:"success",showConfirmButton:!1,timer:1e3,buttonsStyling:!1})},error:function(i){toastr.error("Failed to update status","Error",{showMethod:"fadeIn",hideMethod:"fadeOut"})}})}});var S=$(".data-thumb-view").DataTable();if($(".actions-dropodown").hide(),S.on("select deselect",function(){var a=S.rows({selected:!0}).count();a>0?$(".actions-dropodown").slideDown():$(".actions-dropodown").slideUp()}),$(document).on("click",".bulk-delete-btn",function(a){a.preventDefault();var e=S.rows({selected:!0}),s=[];if(e.nodes().each(function(t){var n=$(t).find(".order_id").val();n&&s.push(n)}),s.length===0){Swal.fire({title:"تنبيه",text:"الرجاء تحديد طلب واحد على الأقل للحذف.",type:"warning",confirmButtonClass:"btn btn-primary",buttonsStyling:!1});return}Swal.fire({title:"هل انت متاكد من حذف "+s.length+" طلب؟",text:"لن تتمكن من التراجع عن هذا!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"نعم، احذفهم!",confirmButtonClass:"btn btn-primary",cancelButtonClass:"btn btn-danger ml-1",buttonsStyling:!1}).then(function(t){t.value&&$.ajax({url:"/printers/bulk-delete",type:"POST",data:{ids:s,_token:$('meta[name="csrf-token"]').attr("content")},success:function(n){e.remove().draw(),$(".actions-dropodown").hide(),Swal.fire({type:"success",title:"تم الحذف!",text:"تم حذف الطلبات المحددة بنجاح.",showConfirmButton:!1,timer:1500,buttonsStyling:!1})},error:function(n){console.error("Bulk delete error:",n),Swal.fire({title:"خطأ!",text:"حدث خطأ أثناء الحذف. حاول مرة أخرى.",type:"error",confirmButtonClass:"btn btn-primary",buttonsStyling:!1})}})})}),!window.papionInvData)console.warn("PapionInvData not found");else{const a=document.getElementById("inkChart");if(a&&typeof Chart<"u"){let e=function(u,f,v=null){const m=u.find(y=>y.machine_type===f&&(v?y.color===v:!0));return m?m.quantity:0},s=function(u,f){const v=u.createLinearGradient(100,75,100,300);return v.addColorStop(0,f),v.addColorStop(1,f+"80"),v};const t=a.getContext("2d"),n=window.papionInvData.inkStocks||[],r=document.getElementById("paperChart").getContext("2d"),i=window.papionInvData.paperStocks||[],o={cyan:"#00CFE8",magenta:"#EA5455",yellow:"#FF9F43",black:"#4B4B4B",white:"#E5E7EB",green:"#28C76F",orange:"#FF9F43"},d={labels:["Sub-C","Sub-M","Sub-Y","Sub-K","DTF-C","DTF-M","DTF-Y","DTF-K","DTF-W"],datasets:[{label:"Ink (L)",data:[e(n,"sublimation","Cyan"),e(n,"sublimation","Magenta"),e(n,"sublimation","Yellow"),e(n,"sublimation","Black"),e(n,"dtf","Cyan"),e(n,"dtf","Magenta"),e(n,"dtf","Yellow"),e(n,"dtf","Black"),e(n,"dtf","White")],backgroundColor:[s(t,o.cyan),s(t,o.magenta),s(t,o.yellow),s(t,o.black),s(t,o.cyan),s(t,o.magenta),s(t,o.yellow),s(t,o.black),o.white],borderColor:"transparent",borderWidth:0,borderRadius:4,elements:{bar:{borderRadius:4}}}]},b=new Chart(t,{type:"bar",data:d,options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,grid:{color:"#e7e7e7",drawBorder:!1},ticks:{stepSize:1,color:"#b9c3cd"}},x:{grid:{display:!1},ticks:{color:"#b9c3cd"}}},plugins:{legend:{display:!1}},animation:{duration:2e3,easing:"easeInOutQuart"}}}),C={labels:["Sublimation","DTF"],datasets:[{label:"Paper (Meters)",data:[e(i,"sublimation"),e(i,"dtf")],backgroundColor:[s(r,o.green),s(r,o.orange)],borderColor:"transparent",borderWidth:0,borderRadius:4,barThickness:50}]};new Chart(r,{type:"bar",data:C,options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,grid:{color:"#e7e7e7",drawBorder:!1},ticks:{color:"#b9c3cd"}},x:{grid:{display:!1},ticks:{color:"#b9c3cd"}}},plugins:{legend:{display:!1}},animation:{duration:2e3,easing:"easeInOutQuart"}}}),$(document).on("click",".consume-ink-btn",function(){let u=$(this).data("type"),f=$(this).data("color");Swal.fire({title:"تأكيد الاستهلاك",text:`هل أنت متأكد من خصم 1 لتر من ${f} (${u})؟`,type:"warning",showCancelButton:!0,confirmButtonText:"نعم، اخصم",cancelButtonText:"إلغاء"}).then(v=>{v.value&&$.ajax({url:window.papionInvData.consumeInkRoute,method:"POST",data:{_token:window.papionInvData.csrfToken,machine_type:u,color:f},success:function(m){Swal.fire("تم!",m.success,"success");let k={Cyan:0,Magenta:1,Yellow:2,Black:3,White:4}[f],c;u==="sublimation"?c=k:f==="White"?c=8:c=4+k,c!==void 0&&b.data.datasets[0]&&(b.data.datasets[0].data[c]=m.new_quantity,b.update())},error:function(m){let y=m.responseJSON?m.responseJSON.error:"حدث خطأ أثناء الخصم";Swal.fire("خطأ!",y,"error")}})})})}else console.log("Chart elements not found or Chart.js not loaded")}});
