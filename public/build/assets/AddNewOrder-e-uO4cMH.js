$(document).ready(function(){$("#data-copies, #data-height, #data-price, #data-pic-copies, #data-machine, #data-pass").on("input change",function(){var a=parseFloat($("#data-copies").val())||0,e=parseFloat($("#data-height").val())||0,s=$("#data-machine").val(),t=$("#data-pass").val();parseFloat($("#data-price").val()),console.log("Machine/Pass changed");var s=$("#data-machine").val(),t=$("#data-pass").val();if(console.log("Machine ID:",s,"Pass:",t),s&&window.papionInvData&&window.papionInvData.machines){var i=window.papionInvData.machines.find(u=>u.id==s);if(console.log("Found Machine:",i),i){var o=0;t==4?o=parseFloat(i.price_4_pass):t==6?o=parseFloat(i.price_6_pass):o=parseFloat(i.price_1_pass),console.log("New Price:",o),o>0&&$("#data-price").val(o).trigger("change")}}else console.warn("Machine Data or ID missing",window.papionInvData);var n=a*e;$("#data-meters").val(n/100);var r=n*o;$("#data-total").val(r.toFixed(2));var d=parseFloat($("#data-pic-copies").val())||0,b=a*d,k=0;d>0&&(k=e/100/d*o),$("#data-price-pic").text(k.toFixed(2)),$("#data-total-pic").text(b),a>0&&e>0?$("#data-meters").prop("disabled",!0):$("#data-meters").prop("disabled",!1)}),$("#data-machine").on("change",function(){var a=$(this).find("option:selected").text().toLowerCase();a.includes("dtf")?($("#data-width").val(58),$("#data-pass").val(4).prop("disabled",!1)):a.includes("sublimation")?($("#data-width").val(150),$("#data-pass").val(1).prop("disabled",!0)):$("#data-pass").prop("disabled",!1)});var g=null,x=!1;function B(){$("#data-customer, #data-customer-view, #data-machine, #data-height, #data-width, #data-copies, #data-pic-copies, #data-pass, #data-meters, #data-price, #data-notes, #data-fabric-type").val(""),$("#data-status").val("waiting"),$("#data-pass").val("1"),h=[],typeof p<"u"&&p&&p.removeAllFiles(),g=null,x=!1,$(".new-data-title h4").text("اضافه اذن تشغيل"),$("#saveDataBtn").text("Add Data")}Dropzone.autoDiscover=!1;var h=[];Dropzone.instances.length>0&&Dropzone.instances.forEach(a=>a.destroy());try{var p=new Dropzone("#dataListUpload",{url:"/printers/upload-image",paramName:"file",maxFiles:10,acceptedFiles:".jpg,.jpeg,.png,.gif,.tiff,.tif,.webp",addRemoveLinks:!0,resizeHeight:110,resizeMimeType:"image/webp",resizeQuality:.9,headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},success:function(a,e){a.serverFileName=e.path,h.push(e.path),console.log("Images uploaded:",h),toastr.success("Image uploaded successfully")},removedfile:function(a){a.previewElement!=null&&a.previewElement.parentNode!=null&&a.previewElement.parentNode.removeChild(a.previewElement);var e=a.serverFileName;if(e){var s=h.indexOf(e);s!==-1&&(h.splice(s,1),console.log("Image removed. Remaining:",h))}return _updateMaxFilesReachedClass()},error:function(a,e){toastr.error("Upload failed:",e.message)}})}catch(a){toastr.error("Dropzone init warning:",a)}document.onpaste=function(a){for(var e=(a.clipboardData||a.originalEvent.clipboardData).items,s=0;s<e.length;s++){var t=e[s];t.kind==="file"&&p.addFile(t.getAsFile())}},$(document).on("click",".action-edit",function(a){a.stopPropagation();var e=$(this).closest("tr"),s=e.find(".order_id").val();s&&$.ajax({url:"/printers/"+s,type:"GET",success:function(t){$("#data-customer-view").val(t.customers?t.customers.name:""),$("#data-machine").val(t.machineId),$("#data-height").val(t.fileHeight),$("#data-width").val(t.fileWidth),$("#data-copies").val(t.fileCopies),$("#data-pic-copies").val(t.picInCopies),$("#data-fabric-type").val(t.fabric_type),$("#data-pass").val(t.pass),$("#data-meters").val(t.meters),$("#data-status").val(t.status),t.printingprices&&$("#data-price").val(t.printingprices.totalPrice),$("#data-notes").val(t.notes),$("#data-price-pic").text(t.manufacturing_cost||0),h=[],typeof p<"u"&&p&&(p.removeAllFiles(!0),t.orders_imgs&&t.orders_imgs.length>0&&t.orders_imgs.forEach(function(r){var d={name:"Image",size:12345,serverFileName:r.path};p.emit("addedfile",d),p.emit("thumbnail",d,"/storage/"+r.path),p.emit("complete",d),p.files.push(d),h.push(r.path)}));var i=parseFloat($("#data-copies").val())||0,o=parseFloat($("#data-pic-copies").val())||0,n=i*o;$("#data-total-pic").text(n),g=t.id,x=!1,$(".new-data-title h4").text("تعديل البيانات"),$("#saveDataBtn").text("حفظ التعديلات"),$(".add-new-data").addClass("show"),$(".overlay-bg").addClass("show")},error:function(t){console.error("Error fetching order:",t),toastr.error("Could not fetch order details.","Error")}})}),$(document).on("click",".action-delete",function(a){a.stopPropagation();var e=$(this).closest("td").parent("tr"),s=e.find(".order_id").val();if(console.log(s),!s){e.fadeOut();return}Swal.fire({title:"هل انت متاكد?",text:"لن تتمكن من التراجع عن هذا!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"نعم، احذفه!",confirmButtonClass:"btn btn-primary",cancelButtonClass:"btn btn-danger ml-1",buttonsStyling:!1}).then(function(t){t.value&&$.ajax({url:"/printers/delete/"+s,type:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content")},success:function(i){console.log("Order deleted:",i),e.fadeOut(function(){$(this).remove()}),Swal.fire({type:"success",title:"تم الحذف!",showConfirmButton:!1,timer:1500,buttonsStyling:!1,confirmButtonClass:"btn btn-primary"})},error:function(i){console.error("Error deleting order:",i),Swal.fire({title:"Error!",text:"Error deleting order. Please try again.",type:"error",confirmButtonClass:"btn btn-primary",buttonsStyling:!1})}})})}),$(".hide-data-sidebar, .cancel-data-btn, .overlay-bg").on("click",function(a){a.stopPropagation(),$(".add-new-data").removeClass("show"),$(".overlay-bg").removeClass("show"),B()}),$("#saveDataBtn").on("click",function(a){a.preventDefault(),console.log("Save/Update Data Button Clicked");var e=$("#data-customer-view").val(),s=$("#data-machine").val(),t=$("#data-height").val(),i=$("#data-width").val(),o=$("#data-copies").val(),n=$("#data-pic-copies").val(),r=$("#data-pass").val(),d=$("#data-meters").val(),b=$("#data-status").val(),k=$("#data-fabric-type").val(),u=$("#data-price").val();$("#data-fabric-type").val();var f=$("#data-notes").val(),v="/printers/store",m="POST",y=parseFloat($("#data-price-pic").text())||0,C={customerId:e,machineId:s,fileHeight:t,fileWidth:i,fileCopies:o,picInCopies:n,pass:r,meters:d,price:u,fabric_type:k,notes:f,manufacturing_cost:y,image_paths:h,_token:$('meta[name="csrf-token"]').attr("content")};g?(v="/printers/"+g,C._method="PUT",x&&(C.auto_advance_status=!0)):C.status=b,$.ajax({url:v,type:m,data:C,success:function(c){try{console.log("Order saved/updated:",c);var F=g?"Order Updated Successfully!":"Order Added Successfully!";if(toastr.success(F,"تمت العملية بنجاح"),!c||!c.order){console.warn("Response missing 'order' object:",c);return}var l=c.order,S=l.customers?l.customers.name:"Unknown",_=l.machines?l.machines.name:"Unknown",E=l.printingprices?l.printingprices.pricePerMeter:"",D=l.orders_imgs&&l.orders_imgs.length>0?"/storage/"+l.orders_imgs[0].path:"/core/images/elements/apple-watch.png";if(g){var w=$('input.order_id[value="'+g+'"]').closest("tr");if(w.length){w.find(".product-img img").attr("src",D),w.find(".product-name").text(S);var P=w.find("td").eq(3);P.text(_+" "+l.pass+" pass");var T=w.find("td").eq(4);T.html("<b>"+l.meters+"</b>"),w.find(".chip-text").text(l.status),w.find(".chip").removeClass("chip-success chip-warning").addClass(l.status=="انتهت الطباعة"?"chip-success":"chip-info"),w.find("td:eq(6)").text(E)}}else{var O=`
                        <tr>
                            <td></td>
                            <td class="product-img">
                                <input type="hidden" class="order_id" value="${l.id}">
                                <img src="${D}" alt="Img placeholder">
                            </td>
                            <td class="product-name">${S}</td>
                            <td class="product-category">${_} ${l.pass} pass</td>
                            <td class="product-category"><b>${l.meters}</b></td>
                            <td>
                                <div class="chip chip-${l.status=="انتهت الطباعة"?"success":"info"}">
                                    <div class="chip-body status-toggle" style="cursor: pointer">
                                        <div class="chip-text">${l.status}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="product-price" title="Just now">الآن</td>
                            <td class="product-action">
                                <span class=" hover_action action-edit "><i class="feather icon-edit"></i></span>
                                <span class=" hover_action action-delete text-danger " ><i class="feather icon-trash"></i></span>
                            </td>
                        </tr>
                    `;$("table.data-thumb-view tbody").append(O)}}catch(M){console.error("Error updating UI:",M),toastr.warning("Order saved, but UI update encountered an issue. Please refresh.","Warning")}finally{$(".add-new-data").removeClass("show"),$(".overlay-bg").removeClass("show"),B()}},error:function(c){if(console.error("Error processing order:",c),c.status===422){var F=c.responseJSON.errors;$.each(F,function(l,S){toastr.error(S[0],"خطا")})}else toastr.error("Error processing order. Please try again.","خطا")}})}),$(document).on("click",".status-toggle",function(a){a.stopPropagation();var e=$(this),s=e.closest("tr"),t=s.find(".order_id").val(),i=e.find(".chip-text"),o=i.text().trim();if(o==="انتهت الطباعة"){s.fadeOut();return}if(t){if(o==="بانتظار اجراء"||o==="بانتظار اجراء"){a.preventDefault(),$.ajax({url:"/printers/"+t,type:"GET",success:function(n){$("#data-customer-view").val(n.customers?n.customers.name:""),$("#data-machine").val(n.machineId),$("#data-height").val(n.fileHeight),$("#data-width").val(n.fileWidth),$("#data-copies").val(n.fileCopies),$("#data-pic-copies").val(n.picInCopies),$("#data-pass").val(n.pass),$("#data-meters").val(n.meters),$("#data-fabric-type").val(n.fabric_type),$("#data-status").val(n.status),n.printingprices&&$("#data-price").val(n.printingprices.totalPrice),$("#data-notes").val(n.notes),g=n.id,x=!0,$(".new-data-title h4").text("تحديث الطلب وبدات الطباعة"),$("#saveDataBtn").text("تحديث وبدء"),$(".add-new-data").addClass("show"),$(".overlay-bg").addClass("show")},error:function(n){console.error("Error fetching order:",n),toastr.error("Could not fetch order details.","Error")}});return}$.ajax({url:"/printers/update-status/"+t,type:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content")},success:function(n){i.text(n.status),Swal.fire({title:" تحديث الحالة :"+n.status,text:"Status updated to "+n.status,type:"success",showConfirmButton:!1,timer:1e3,buttonsStyling:!1})},error:function(n){toastr.error("Failed to update status","Error",{showMethod:"fadeIn",hideMethod:"fadeOut"})}})}});var I=$(".data-thumb-view").DataTable();if($(".actions-dropodown").hide(),I.on("select deselect",function(){var a=I.rows({selected:!0}).count();a>0?$(".actions-dropodown").slideDown():$(".actions-dropodown").slideUp()}),$(document).on("click",".bulk-delete-btn",function(a){a.preventDefault();var e=I.rows({selected:!0}),s=[];if(e.nodes().each(function(t){var i=$(t).find(".order_id").val();i&&s.push(i)}),s.length===0){Swal.fire({title:"تنبيه",text:"الرجاء تحديد طلب واحد على الأقل للحذف.",type:"warning",confirmButtonClass:"btn btn-primary",buttonsStyling:!1});return}Swal.fire({title:"هل انت متاكد من حذف "+s.length+" طلب؟",text:"لن تتمكن من التراجع عن هذا!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"نعم، احذفهم!",confirmButtonClass:"btn btn-primary",cancelButtonClass:"btn btn-danger ml-1",buttonsStyling:!1}).then(function(t){t.value&&$.ajax({url:"/printers/bulk-delete",type:"POST",data:{ids:s,_token:$('meta[name="csrf-token"]').attr("content")},success:function(i){e.remove().draw(),$(".actions-dropodown").hide(),Swal.fire({type:"success",title:"تم الحذف!",text:"تم حذف الطلبات المحددة بنجاح.",showConfirmButton:!1,timer:1500,buttonsStyling:!1})},error:function(i){console.error("Bulk delete error:",i),Swal.fire({title:"خطأ!",text:"حدث خطأ أثناء الحذف. حاول مرة أخرى.",type:"error",confirmButtonClass:"btn btn-primary",buttonsStyling:!1})}})})}),!window.papionInvData)console.warn("PapionInvData not found");else{const a=document.getElementById("inkChart");if(a&&typeof Chart<"u"){let e=function(u,f,v=null){const m=u.find(y=>y.machine_type===f&&(v?y.color===v:!0));return m?m.quantity:0},s=function(u,f){const v=u.createLinearGradient(100,75,100,300);return v.addColorStop(0,f),v.addColorStop(1,f+"80"),v};const t=a.getContext("2d"),i=window.papionInvData.inkStocks||[],o=document.getElementById("paperChart").getContext("2d"),n=window.papionInvData.paperStocks||[],r={cyan:"#00CFE8",magenta:"#EA5455",yellow:"#FF9F43",black:"#4B4B4B",white:"#E5E7EB",green:"#28C76F",orange:"#FF9F43"},d={labels:["Sub-C","Sub-M","Sub-Y","Sub-K","DTF-C","DTF-M","DTF-Y","DTF-K","DTF-W"],datasets:[{label:"Ink (L)",data:[e(i,"sublimation","Cyan"),e(i,"sublimation","Magenta"),e(i,"sublimation","Yellow"),e(i,"sublimation","Black"),e(i,"dtf","Cyan"),e(i,"dtf","Magenta"),e(i,"dtf","Yellow"),e(i,"dtf","Black"),e(i,"dtf","White")],backgroundColor:[s(t,r.cyan),s(t,r.magenta),s(t,r.yellow),s(t,r.black),s(t,r.cyan),s(t,r.magenta),s(t,r.yellow),s(t,r.black),r.white],borderColor:"transparent",borderWidth:0,borderRadius:4,elements:{bar:{borderRadius:4}}}]},b=new Chart(t,{type:"bar",data:d,options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,grid:{color:"#e7e7e7",drawBorder:!1},ticks:{stepSize:1,color:"#b9c3cd"}},x:{grid:{display:!1},ticks:{color:"#b9c3cd"}}},plugins:{legend:{display:!1}},animation:{duration:2e3,easing:"easeInOutQuart"}}}),k={labels:["Sublimation","DTF"],datasets:[{label:"Paper (Meters)",data:[e(n,"sublimation"),e(n,"dtf")],backgroundColor:[s(o,r.green),s(o,r.orange)],borderColor:"transparent",borderWidth:0,borderRadius:4,barThickness:50}]};new Chart(o,{type:"bar",data:k,options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,grid:{color:"#e7e7e7",drawBorder:!1},ticks:{color:"#b9c3cd"}},x:{grid:{display:!1},ticks:{color:"#b9c3cd"}}},plugins:{legend:{display:!1}},animation:{duration:2e3,easing:"easeInOutQuart"}}}),$(document).on("click",".consume-ink-btn",function(){let u=$(this).data("type"),f=$(this).data("color");Swal.fire({title:"تأكيد الاستهلاك",text:`هل أنت متأكد من خصم 1 لتر من ${f} (${u})؟`,type:"warning",showCancelButton:!0,confirmButtonText:"نعم، اخصم",cancelButtonText:"إلغاء"}).then(v=>{v.value&&$.ajax({url:window.papionInvData.consumeInkRoute,method:"POST",data:{_token:window.papionInvData.csrfToken,machine_type:u,color:f},success:function(m){Swal.fire("تم!",m.success,"success");let C={Cyan:0,Magenta:1,Yellow:2,Black:3,White:4}[f],c;u==="sublimation"?c=C:f==="White"?c=8:c=4+C,c!==void 0&&b.data.datasets[0]&&(b.data.datasets[0].data[c]=m.new_quantity,b.update())},error:function(m){let y=m.responseJSON?m.responseJSON.error:"حدث خطأ أثناء الخصم";Swal.fire("خطأ!",y,"error")}})})})}else console.log("Chart elements not found or Chart.js not loaded")}$(document).on("click",".product-img img",function(){var a=$(this).attr("src");a&&($("#enlarged-image").attr("src",a),$("#imageZoomModal").modal("show"))}),$(".close-zoom").on("click",function(){$("#imageZoomModal").modal("hide")})});
