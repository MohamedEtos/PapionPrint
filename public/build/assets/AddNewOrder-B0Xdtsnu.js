$(document).ready(function(){$("#data-copies, #data-height,  #data-price ,#data-pic-copies").on("input",function(){var t=parseFloat($("#data-copies").val())||0,e=parseFloat($("#data-height").val())||0,d=parseFloat($("#data-price").val())||0,i=t*e;$("#data-meters").val(i/100);var a=i*d;$("#data-total").val(a);var r=parseFloat($("#data-pic-copies").val())||0,c=parseFloat(170)||0,s=t*r,d=e/100/r*c;$("#data-price-pic").text(d),$("#data-total-pic").text(s),t>0&&e>0?$("#data-meters").prop("disabled",!0):$("#data-meters").prop("disabled",!1)}),$("#data-machine").on("change",function(){var t=$(this).find("option:selected").text().toLowerCase();t.includes("dtf")?($("#data-width").val(58),$("#data-pass").val(4).prop("disabled",!1)):t.includes("sublimation")?($("#data-width").val(150),$("#data-pass").val(1).prop("disabled",!0)):$("#data-pass").prop("disabled",!1)});var u=null;function w(){$("#data-customer, #data-customer-view, #data-machine, #data-height, #data-width, #data-copies, #data-pic-copies, #data-pass, #data-meters, #data-price, #data-notes, #data-fabric-type").val(""),$("#data-status").val("waiting"),$("#data-pass").val("1"),l=[],typeof o<"u"&&o&&o.removeAllFiles(),u=null,$(".new-data-title h4").text("اضافه اذن تشغيل"),$("#saveDataBtn").text("Add Data")}Dropzone.autoDiscover=!1;var l=[];Dropzone.instances.length>0&&Dropzone.instances.forEach(t=>t.destroy());try{var o=new Dropzone("#dataListUpload",{url:"/printers/upload-image",paramName:"file",maxFiles:10,acceptedFiles:".jpg,.jpeg,.png,.gif,.tiff,.tif,.webp",addRemoveLinks:!0,resizeHeight:110,resizeMimeType:"image/webp",resizeQuality:.9,headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},success:function(t,e){t.serverFileName=e.path,l.push(e.path),console.log("Images uploaded:",l),toastr.success("Image uploaded successfully")},removedfile:function(t){t.previewElement!=null&&t.previewElement.parentNode!=null&&t.previewElement.parentNode.removeChild(t.previewElement);var e=t.serverFileName;if(e){var i=l.indexOf(e);i!==-1&&(l.splice(i,1),console.log("Image removed. Remaining:",l))}return _updateMaxFilesReachedClass()},error:function(t,e){toastr.error("Upload failed:",e.message)}})}catch(t){toastr.error("Dropzone init warning:",t)}document.onpaste=function(t){for(var e=(t.clipboardData||t.originalEvent.clipboardData).items,i=0;i<e.length;i++){var a=e[i];a.kind==="file"&&o.addFile(a.getAsFile())}},$(document).on("click",".action-edit",function(t){t.stopPropagation();var e=$(this).closest("tr"),i=e.find(".order_id").val();i&&$.ajax({url:"/printers/"+i,type:"GET",success:function(a){$("#data-customer-view").val(a.customers?a.customers.name:""),$("#data-machine").val(a.machineId),$("#data-height").val(a.fileHeight),$("#data-width").val(a.fileWidth),$("#data-copies").val(a.fileCopies),$("#data-pic-copies").val(a.picInCopies),$("#data-fabric-type").val(a.fabric_type),$("#data-pass").val(a.pass),$("#data-meters").val(a.meters),$("#data-status").val(a.status),a.printingprices&&$("#data-price").val(a.printingprices.totalPrice),$("#data-notes").val(a.notes),l=[],typeof o<"u"&&o&&(o.removeAllFiles(!0),a.orders_imgs&&a.orders_imgs.length>0&&a.orders_imgs.forEach(function(d){var f={name:"Image",size:12345,serverFileName:d.path};o.emit("addedfile",f),o.emit("thumbnail",f,"/storage/"+d.path),o.emit("complete",f),o.files.push(f),l.push(d.path)}));var r=parseFloat($("#data-copies").val())||0,c=parseFloat($("#data-pic-copies").val())||0,s=r*c;$("#data-total-pic").text(s),u=a.id,$(".new-data-title h4").text("تعديل البيانات"),$("#saveDataBtn").text("حفظ التعديلات"),$(".add-new-data").addClass("show"),$(".overlay-bg").addClass("show")},error:function(a){console.error("Error fetching order:",a),toastr.error("Could not fetch order details.","Error")}})}),$(document).on("click",".action-delete",function(t){t.stopPropagation();var e=$(this).closest("td").parent("tr"),i=e.find(".order_id").val();if(console.log(i),!i){e.fadeOut();return}Swal.fire({title:"هل انت متاكد?",text:"لن تتمكن من التراجع عن هذا!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"نعم، احذفه!",confirmButtonClass:"btn btn-primary",cancelButtonClass:"btn btn-danger ml-1",buttonsStyling:!1}).then(function(a){a.value&&$.ajax({url:"/printers/delete/"+i,type:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content")},success:function(r){console.log("Order deleted:",r),e.fadeOut(function(){$(this).remove()}),Swal.fire({type:"success",title:"تم الحذف!",showConfirmButton:!1,timer:1500,buttonsStyling:!1,confirmButtonClass:"btn btn-primary"})},error:function(r){console.error("Error deleting order:",r),Swal.fire({title:"Error!",text:"Error deleting order. Please try again.",type:"error",confirmButtonClass:"btn btn-primary",buttonsStyling:!1})}})})}),$(".hide-data-sidebar, .cancel-data-btn, .overlay-bg").on("click",function(t){t.stopPropagation(),$(".add-new-data").removeClass("show"),$(".overlay-bg").removeClass("show"),w()}),$("#saveDataBtn").on("click",function(t){t.preventDefault(),console.log("Save/Update Data Button Clicked");var e=$("#data-customer-view").val(),i=$("#data-machine").val(),a=$("#data-height").val(),r=$("#data-width").val(),c=$("#data-copies").val(),s=$("#data-pic-copies").val(),d=$("#data-pass").val(),f=$("#data-meters").val(),S=$("#data-status").val(),_=$("#data-fabric-type").val(),k=$("#data-price").val();$("#data-fabric-type").val();var B=$("#data-notes").val(),y="/printers/store",I="POST",g={customerId:e,machineId:i,fileHeight:a,fileWidth:r,fileCopies:c,picInCopies:s,pass:d,meters:f,status:S,price:k,fabric_type:_,notes:B,image_paths:l,_token:$('meta[name="csrf-token"]').attr("content")};u&&(y="/printers/"+u,g._method="PUT",g.auto_advance_status=!0),$.ajax({url:y,type:I,data:g,success:function(p){try{console.log("Order saved/updated:",p);var b=u?"Order Updated Successfully!":"Order Added Successfully!";if(toastr.success(b,"تمت العملية بنجاح"),!p||!p.order){console.warn("Response missing 'order' object:",p);return}var n=p.order,m=n.customers?n.customers.name:"Unknown",C=n.machines?n.machines.name:"Unknown",E=n.printingprices?n.printingprices.pricePerMeter:"",x=n.orders_imgs&&n.orders_imgs.length>0?"/storage/"+n.orders_imgs[0].path:"/core/images/elements/apple-watch.png";if(u){var v=$('input.order_id[value="'+u+'"]').closest("tr");if(v.length){v.find(".product-img img").attr("src",x),v.find(".product-name").text(m);var F=v.find("td").eq(3);F.text(C+" "+n.pass+" pass");var O=v.find("td").eq(4);O.html("<b>"+n.meters+"</b>"),v.find(".chip-text").text(n.status),v.find(".chip").removeClass("chip-success chip-warning").addClass(n.status=="انتهت الطباعة"?"chip-success":"chip-info"),v.find("td:eq(6)").text(E)}}else{var P=`
                        <tr>
                            <td></td>
                            <td class="product-img">
                                <input type="hidden" class="order_id" value="${n.id}">
                                <img src="${x}" alt="Img placeholder">
                            </td>
                            <td class="product-name">${m}</td>
                            <td class="product-category">${C} ${n.pass} pass</td>
                            <td class="product-category"><b>${n.meters}</b></td>
                            <td>
                                <div class="chip chip-${n.status=="انتهت الطباعة"?"success":"info"}">
                                    <div class="chip-body status-toggle" style="cursor: pointer">
                                        <div class="chip-text">${n.status}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="product-price" title="Just now">الآن</td>
                            <td class="product-action">
                                <span class=" hover_action action-edit "><i class="feather icon-edit"></i></span>
                                <span class=" hover_action action-delete text-danger " ><i class="feather icon-trash"></i></span>
                            </td>
                        </tr>
                    `;$("table.data-thumb-view tbody").append(P)}}catch(T){console.error("Error updating UI:",T),toastr.warning("Order saved, but UI update encountered an issue. Please refresh.","Warning")}finally{$(".add-new-data").removeClass("show"),$(".overlay-bg").removeClass("show"),w()}},error:function(p){if(console.error("Error processing order:",p),p.status===422){var b=p.responseJSON.errors;$.each(b,function(n,m){toastr.error(m[0],"خطا")})}else toastr.error("Error processing order. Please try again.","خطا")}})}),$(document).on("click",".status-toggle",function(t){t.stopPropagation();var e=$(this),i=e.closest("tr"),a=i.find(".order_id").val(),r=e.find(".chip-text"),c=r.text().trim();if(c==="انتهت الطباعة"){i.fadeOut();return}if(a){if(c==="بانتظار اجراء"||c==="بانتظار اجراء"){t.preventDefault(),$.ajax({url:"/printers/"+a,type:"GET",success:function(s){$("#data-customer-view").val(s.customers?s.customers.name:""),$("#data-machine").val(s.machineId),$("#data-height").val(s.fileHeight),$("#data-width").val(s.fileWidth),$("#data-copies").val(s.fileCopies),$("#data-pic-copies").val(s.picInCopies),$("#data-pass").val(s.pass),$("#data-meters").val(s.meters),$("#data-fabric-type").val(s.fabric_type),$("#data-status").val(s.status),s.printingprices&&$("#data-price").val(s.printingprices.totalPrice),$("#data-notes").val(s.notes),u=s.id,$(".new-data-title h4").text("تحديث الطلب وبدات الطباعة"),$("#saveDataBtn").text("تحديث وبدء"),$(".add-new-data").addClass("show"),$(".overlay-bg").addClass("show")},error:function(s){console.error("Error fetching order:",s),toastr.error("Could not fetch order details.","Error")}});return}$.ajax({url:"/printers/update-status/"+a,type:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content")},success:function(s){r.text(s.status),Swal.fire({title:" تحديث الحالة :"+s.status,text:"Status updated to "+s.status,type:"success",showConfirmButton:!1,timer:1e3,buttonsStyling:!1})},error:function(s){toastr.error("Failed to update status","Error",{showMethod:"fadeIn",hideMethod:"fadeOut"})}})}});var h=$(".data-thumb-view").DataTable();$(".actions-dropodown").hide(),h.on("select deselect",function(){var t=h.rows({selected:!0}).count();t>0?$(".actions-dropodown").slideDown():$(".actions-dropodown").slideUp()}),$(document).on("click",".bulk-delete-btn",function(t){t.preventDefault();var e=h.rows({selected:!0}),i=[];if(e.nodes().each(function(a){var r=$(a).find(".order_id").val();r&&i.push(r)}),i.length===0){Swal.fire({title:"تنبيه",text:"الرجاء تحديد طلب واحد على الأقل للحذف.",type:"warning",confirmButtonClass:"btn btn-primary",buttonsStyling:!1});return}Swal.fire({title:"هل انت متاكد من حذف "+i.length+" طلب؟",text:"لن تتمكن من التراجع عن هذا!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"نعم، احذفهم!",confirmButtonClass:"btn btn-primary",cancelButtonClass:"btn btn-danger ml-1",buttonsStyling:!1}).then(function(a){a.value&&$.ajax({url:"/printers/bulk-delete",type:"POST",data:{ids:i,_token:$('meta[name="csrf-token"]').attr("content")},success:function(r){e.remove().draw(),$(".actions-dropodown").hide(),Swal.fire({type:"success",title:"تم الحذف!",text:"تم حذف الطلبات المحددة بنجاح.",showConfirmButton:!1,timer:1500,buttonsStyling:!1})},error:function(r){console.error("Bulk delete error:",r),Swal.fire({title:"خطأ!",text:"حدث خطأ أثناء الحذف. حاول مرة أخرى.",type:"error",confirmButtonClass:"btn btn-primary",buttonsStyling:!1})}})})})});
