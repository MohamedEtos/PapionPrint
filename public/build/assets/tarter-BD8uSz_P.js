$(document).ready(function(){var p=$(".steps-validation").show();$(document).on("input","#data-required-pieces, #data-pieces-per-card",function(){var a=parseFloat($("#data-required-pieces").val()),e=parseFloat($("#data-pieces-per-card").val());if(a>0&&e>0){var t=Math.ceil(a/e),r=$("#data-cards-count");r.val()!=t&&(r.val(t),r.removeClass("flash-input"),r.closest(".form-control").get(0).offsetWidth,r.addClass("flash-input"),setTimeout(function(){r.removeClass("flash-input")},1e3))}}),$(".steps-validation").steps({headerTag:"h6",bodyTag:"fieldset",transitionEffect:"fade",titleTemplate:'<span class="step">#index#</span> #title#',labels:{finish:"Submit"},onStepChanging:function(a,e,t){return e>t?!0:(e<t&&(p.find(".body:eq("+t+") label.error").remove(),p.find(".body:eq("+t+") .error").removeClass("error")),p.validate().settings.ignore=":disabled,:hidden",p.valid())},onFinishing:function(a,e){return p.validate().settings.ignore=":disabled",p.valid()},onFinished:function(a,e){B()}}),$(".steps-validation").validate({ignore:"input[type=hidden]",errorClass:"danger",successClass:"success",highlight:function(a,e){$(a).removeClass(e)},unhighlight:function(a,e){$(a).removeClass(e)},errorPlacement:function(a,e){a.insertAfter(e)}});var g=$(".data-thumb-view").DataTable({responsive:!1,deferRender:!0,columnDefs:[{orderable:!0,targets:0,checkboxes:{selectRow:!0}}],dom:'<"top"<"actions action-btns"B><"action-filters"lf>><"clear">rt<"bottom"<"actions">p>',oLanguage:{sLengthMenu:"_MENU_",sSearch:""},aLengthMenu:[[4,10,15,20],[4,10,15,20]],select:{style:"multi"},order:[[1,"desc"]],bInfo:!1,pageLength:4,buttons:[{text:"<i class='feather icon-plus'></i> إضافة طلب جديد",action:function(a,e,t,r){$("#validation").slideToggle(function(){var n=$(this).is(":visible");e.button(t).text(n?'<i class="feather icon-x"></i> اغـــلاق':"<i class='feather icon-plus'></i> إضافة طلب جديد")})},className:"btn-outline-primary"}],initComplete:function(a,e){$(".dt-buttons .btn").removeClass("btn-secondary")}}),P=$(".actions-dropodown");P.insertBefore($(".top .actions .dt-buttons")),$(".data-items").length>0&&new PerfectScrollbar(".data-items",{wheelPropagation:!1}),$(".hide-data-sidebar, .cancel-data-btn, .overlay-bg").on("click",function(){$(".add-new-data").removeClass("show"),$(".overlay-bg").removeClass("show"),$("#data-name, #data-price").val(""),$("#data-category, #data-status").prop("selectedIndex",0)});var C=null;let b=1;$("#add-layer-btn").on("click",function(){var a=$("#layers-container .layer-row").first(),e=a.clone();e.find(".layer-size").attr("name","layers["+b+"][size]").val(""),e.find(".layer-count").attr("name","layers["+b+"][count]").val(""),$("#layers-container").append(e),b++}),$(document).on("click",".remove-layer-btn",function(){$("#layers-container .layer-row").length>1?$(this).closest(".layer-row").remove():$(this).closest(".layer-row").find("input, select").val("")}),$(document).on("paste",function(a){var e=(a.clipboardData||a.originalEvent.clipboardData).items;for(var t in e){var r=e[t];if(r.kind==="file"&&r.type.indexOf("image/")!==-1){var n=r.getAsFile(),l=new File([n],"pasted-image.png",{type:n.type});let s=new DataTransfer;s.items.add(l),$("#data-image-upload")[0].files=s.files;var i=new FileReader;i.onload=function(d){$("#pasted-image-preview img").attr("src",d.target.result),$("#pasted-image-preview").show()},i.readAsDataURL(n),toastr.success("Image pasted successfully!","Success")}}}),$("#data-image-upload").on("change",function(){if(this.files&&this.files[0]){var a=new FileReader;a.onload=function(e){$("#pasted-image-preview img").attr("src",e.target.result),$("#pasted-image-preview").show()},a.readAsDataURL(this.files[0])}});function B(){var a=new FormData,e=$("#data-customer").val(),t=$("#data-customer-view").val();if(!e){var r=$('#customers-list option[value="'+t+'"]');r.length>0&&(e=r.attr("data-id"))}a.append("customerId",e||""),a.append("height",$("#data-height").val()),a.append("width",$("#data-width").val()),a.append("cards_count",$("#data-cards-count").val()),a.append("pieces_per_card",$("#data-pieces-per-card").val()),a.append("machine_time",$("#data-machine-time").val()),a.append("notes",$("#data-notes").val()),$("#layers-container .layer-row").each(function(s,d){var h=$(d).find(".layer-size").val(),u=$(d).find(".layer-count").val();h&&u&&(a.append("layers["+s+"][size]",h),a.append("layers["+s+"][count]",u))}),a.append("_token",$('meta[name="csrf-token"]').attr("content"));var n=$("#data-image-upload")[0].files[0];n&&a.append("image",n);var l="/tarter/store",i="POST";C&&(l="/tarter/update/"+C,a.append("_method","PUT")),$.ajax({url:l,type:i,data:a,processData:!1,contentType:!1,success:function(s){console.log("Order saved:",s),Swal.fire({type:"success",title:"تم التسجيل بنجاح!",showConfirmButton:!1,timer:1500,buttonsStyling:!1,confirmButtonClass:"btn btn-primary"}),$("#validation").slideUp(),setTimeout(function(){location.reload()},1e3)},error:function(s){if(console.error("Error processing order:",s),s.status===422){var d=s.responseJSON.errors;$.each(d,function(h,u){toastr.error(u[0],"خطا")})}else toastr.error("Error processing order. Please try again.","خطا")}})}window.editTarter=function(a){C=a,$.get("/tarter/show/"+a,function(e){$(".new-data-title h4").text("تعديل طلب"),$("#saveDataBtn").text("Update"),$("#data-customer").val(e.customer_id),e.customer&&$("#data-customer-view").val(e.customer.name),$("#data-height").val(e.height),$("#data-width").val(e.width),$("#data-cards-count").val(e.cards_count),$("#data-pieces-per-card").val(e.pieces_per_card),$("#data-machine-time").val(e.machine_time),$("#data-notes").val(e.notes),e.cards_count&&e.pieces_per_card&&$("#data-required-pieces").val(e.cards_count*e.pieces_per_card),$("#layers-container").empty(),e.layers&&e.layers.length>0?(e.layers.forEach(function(t,r){var n=`<div class="layer-row row mb-1">
                                        <div class="col-md-5">
                                            <div class="form-group">
                                                <label>مقاس الإبرة</label>
                                                <select class="form-control layer-size" name="layers[${r}][size]">
                                                     // Options will be set below
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <div class="form-group">
                                                <label>العدد</label>
                                                <input type="number" class="form-control layer-count" name="layers[${r}][count]" placeholder="عدد الحبات" value="${t.count}">
                                            </div>
                                        </div>
                                        <div class="col-md-2 d-flex align-items-center">
                                            <button type="button" class="btn btn-danger btn-icon remove-layer-btn"><i class="feather icon-trash"></i></button>
                                        </div>
                                    </div>`,l=$(n),i="";window.tarterPrices&&window.tarterPrices.forEach(function(s){s.type==="needle"&&(i+=`<option value="${s.size}">${s.size}</option>`)}),i===""&&(i='<option value="9">9</option><option value="11">11</option><option value="14">14</option>'),l.find(".layer-size").html(i).val(t.size),$("#layers-container").append(l)}),b=e.layers.length):$("#add-layer-btn").trigger("click"),$("#validation").slideDown(),$("html, body").animate({scrollTop:$("#validation").offset().top},500)})},window.deleteTarter=function(a){Swal.fire({title:"هل انت متأكد؟",text:"لن تتمكن من استرجاع هذا الطلب!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"نعم، احذفه!",cancelButtonText:"الغاء"}).then(e=>{e.value&&$.ajax({url:"/tarter/delete/"+a,type:"DELETE",data:{_token:$('meta[name="csrf-token"]').attr("content")},success:function(t){Swal.fire("تم الحذف!","تم حذف الطلب بنجاح.","success").then(()=>{location.reload()})},error:function(t){Swal.fire("خطأ!","حدث خطأ اثناء الحذف.","error")}})})},window.restartTarter=function(a){Swal.fire({title:"إعادة تشغيل؟",text:"سيتم إنشاء نسخة جديدة من هذا الطلب.",type:"question",showCancelButton:!0,confirmButtonText:"نعم، أعد التشغيل",cancelButtonText:"الغاء"}).then(e=>{e.value&&$.ajax({url:"/tarter/restart/"+a,type:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content")},success:function(t){Swal.fire("تم!","تم إعادة تشغيل الطلب بنجاح.","success").then(()=>{location.reload()})},error:function(t){Swal.fire("خطأ!","حدث خطأ اثناء العملية.","error")}})})},g.on("select deselect",function(){var a=g.rows({selected:!0}).count();a>0&&$(".action-btns").show(),D()}),$("#bulk-delete-btn").on("click",function(){var a=g.rows({selected:!0}).nodes(),e=[];$.each(a,function(t,r){var n=$(r).find(".tarter_id").val();n&&e.push(n)}),e.length!==0&&Swal.fire({title:"هل انت متأكد؟",text:"سيتم حذف "+e.length+" طلب/طلبات ولن تستطيع استرجاعهم!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"نعم، احذف",cancelButtonText:"الغاء"}).then(t=>{t.value&&$.ajax({url:"/tarter/bulk-delete",type:"POST",data:{ids:e,_token:$('meta[name="csrf-token"]').attr("content")},success:function(r){Swal.fire("تم الحذف!","تم حذف الطلبات المحددة بنجاح.","success").then(()=>{location.reload()})},error:function(r){Swal.fire("خطأ!","حدث خطأ اثناء الحذف.","error")}})})});function D(){var a={},e=0,t=0,r=0,n=0,l=0,i={needle:{},paper:{},global:{},machine:0};window.tarterPrices&&window.tarterPrices.forEach(function(o){if(o.type==="needle")i.needle[o.size]=parseFloat(o.price)||0;else if(o.type==="paper"){var f=o.size.replace(/\D/g,"");f&&(i.paper[f]=parseFloat(o.price)||0)}else o.type==="global"&&o.size==="operating_cost"?i.global.op_cost=parseFloat(o.price)||0:o.type==="machine_time_cost"&&(i.machine=parseFloat(o.price)||0)});function s(o){var f=Math.round(o);return i.paper[f]?i.paper[f]:0}var d=g.rows({selected:!0}).nodes(),h=d.length>0;$.each(d,function(o,f){var v=$(f),T=parseFloat(v.data("height"))||0,O=parseFloat(v.data("width"))||0,m=parseFloat(v.data("cards-count"))||0,k=parseFloat(v.data("pieces-per-card"))||0,F=parseFloat(v.data("machine-time"))||0;m>0&&(e+=T*m/100),m>0&&k>0&&(t+=m*k),r+=F;var y=0,j=s(O),q=T/100*j;y+=q;var I=i.global.op_cost||0;y+=I;var L=F*i.machine,w=v.data("layers");if(w){if(typeof w=="string")try{w=JSON.parse(w)}catch{}$.each(w,function(U,z){var x=z.size,S=parseFloat(z.count)||0;a[x]||(a[x]=0),a[x]+=S;var N=i.needle[x]||0;y+=S*N})}var M=y*m+L;l+=M,n+=m});var u=$("#tarter-calculator-results");if(h){var c="";if(e>0&&(c+='<span class="badge badge-info mb-1" style="font-size: 1em; margin-left:15px;"><i class="feather icon-maximize-2"></i>  طول الورق : '+e.toFixed(2)+" متر</span>"),t>0&&(c+='<span class="badge badge-warning mb-1" style="font-size: 1em; margin-left:15px;"><i class="feather icon-package"></i> اجمالي القطع : '+t+" </span>"),r>0&&(c+='<span class="badge badge-danger mb-1" style="font-size: 1em; margin-left:15px;"><i class="feather icon-clock"></i> وقت الماكينة : '+r+" دقيقة</span>"),l>0)if(c+='<span class="badge badge-primary mb-1" style="font-size: 1em; margin-left:15px;"><i class="feather icon-dollar-sign"></i> الاجمالي : '+l.toFixed(2)+" جنيه</span>",n>0){var E=l/n;if(c+='<span class="badge badge-purple mb-1" style="font-size: 1em; margin-left:15px; background-color: #6f42c1; color:white;"><i class="feather icon-tag"></i> تكلفة الكارت : '+E.toFixed(3)+" جنيه</span>",t>0){var R=l/t;c+='<span class="badge badge-warning mb-1" style="font-size: 1em; margin-left:15px; background-color: #ff9f43; color:white;"><i class="feather icon-disc"></i> تكلفة القطعة : '+R.toFixed(4)+" جنيه</span>"}c+="<br>"}else c+="<br>";else(e>0||t>0)&&(c+="<br>");c+='<i class="feather icon-bar-chart-2"></i> اجمالي الترتر: &nbsp;&nbsp;';var _=[];Object.keys(a).sort((o,f)=>o-f).forEach(function(o){_.push('<span class="badge badge-success" style="font-size: 1em; margin-left:5px;"> مقاس '+o+": "+a[o]+" </span>")}),_.length===0?c+="لا توجد طبقات محددة":c+=_.join(" "),u.html(c).slideDown()}else u.slideUp()}window.addToInvoice=function(){var a=g.rows({selected:!0}).nodes(),e=[];if($.each(a,function(t,r){var n=$(r).find(".tarter_id").val();n&&e.push(n)}),e.length===0){toastr.warning("Please select items first");return}$.post("/invoices/add",{_token:$('meta[name="csrf-token"]').attr("content"),ids:e,type:"tarter"},function(t){toastr.success("تمت الاضافة للفاتورة"),t.cart_count!==void 0&&($(".cart-item-count").text(t.cart_count),$(".badge.badge-up.cart-item-count").text(t.cart_count)),t.cart_html&&$("#cart-dropdown-items").html(t.cart_html)}).fail(function(){toastr.error("حدث خطأ")})}});
