$(document).ready(function(){var l=$(".data-thumb-view").DataTable({responsive:!1,deferRender:!0,columnDefs:[{orderable:!0,targets:0,checkboxes:{selectRow:!0}}],dom:'<"top"<"actions action-btns"B><"action-filters"lf>><"clear">rt<"bottom"<"actions">p>',oLanguage:{sLengthMenu:"_MENU_",sSearch:""},aLengthMenu:[[4,10,15,20],[4,10,15,20]],select:{style:"multi"},order:[[1,"desc"]],bInfo:!1,pageLength:4,buttons:[{text:"<i class='feather icon-plus'></i> إضافة طلب جديد",action:function(){$("#addOrderModal").modal("show")},className:"btn-outline-primary"}],initComplete:function(t,e){$(".dt-buttons .btn").removeClass("btn-secondary")}}),w=$(".actions-dropodown");w.insertBefore($(".top .actions .dt-buttons")),l.on("select deselect",function(){var t=l.rows({selected:!0}).nodes(),e=0,a=0,o=0,r=0;if(t.each(function(n){let s=parseFloat($(n).data("cost"))||0,i=parseFloat($(n).data("height"))||0,c=parseFloat($(n).data("section-count"))||0,u=parseFloat($(n).data("required-pieces"))||0;e+=s,a+=i*c,o+=c,r+=u}),e>0){let n='<span class="badge badge-primary" style="font-size: 1em; margin-left:10px;"><i class="feather icon-dollar-sign"></i> الإجمالي: '+e.toFixed(2)+" جنيه</span>";if(r>0){let s=e/r;n+='<span class="badge badge-warning" style="font-size: 1em; margin-left:10px;"><i class="feather icon-tag"></i> سعر القطعة: '+s.toFixed(2)+" جنيه</span>"}if(o>0){let s=e/o;n+='<span class="badge badge-info" style="font-size: 1em; margin-left:10px;"><i class="feather icon-layers"></i> سعر المقطع: '+s.toFixed(2)+" جنيه</span>"}n+='<span class="badge badge-success" style="font-size: 1em; margin-left:10px;"><i class="feather icon-maximize-2"></i> إجمالي الأمتار: '+(a/100).toFixed(2)+" م</span>",$("#selected-total").html(n),$("#laser-calculator-results").slideDown()}else $("#laser-calculator-results").slideUp()}),$("#bulk-delete-btn").on("click",function(){var t=[],e=l.rows({selected:!0}).nodes();if($(e).each(function(){var a=$(this).data("id");a&&t.push(a)}),t.length===0){Swal.fire("تنبيه","يرجى تحديد طلبات للحذف","warning");return}Swal.fire({title:"حذف "+t.length+" طلب؟",text:"سيتم حذف جميع الطلبات المحددة نهائياً",type:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"نعم، احذف الكل",cancelButtonText:"إلغاء"}).then(a=>{a.value&&$.ajax({url:"/laser/bulk-delete",type:"POST",data:{_token:window.laserConfig.csrfToken,ids:t},success:function(){Swal.fire("تم الحذف!","تم حذف الطلبات المحددة بنجاح","success"),l.rows({selected:!0}).remove().draw()},error:function(){Swal.fire("خطأ!","حدث خطأ أثناء الحذف","error")}})})}),$("#bulk-recalc-btn").on("click",function(){var t=[],e=l.rows({selected:!0}).nodes();if($(e).each(function(){var a=$(this).data("id");a&&t.push(a)}),t.length===0){Swal.fire("تنبيه","يرجى تحديد طلبات للتحديث","warning");return}Swal.fire({title:"تحديث أسعار "+t.length+" طلب؟",text:"سيتم إعادة حساب التكلفة بناءً على أسعار الخامات الحالية",type:"question",showCancelButton:!0,confirmButtonColor:"#7367F0",cancelButtonColor:"#6c757d",confirmButtonText:"نعم، تحديث",cancelButtonText:"إلغاء"}).then(a=>{a.value&&$.ajax({url:"/laser/bulk-recalculate",type:"POST",data:{_token:window.laserConfig.csrfToken,ids:t},success:function(o){Swal.fire("تم!",o.success,"success"),setTimeout(function(){location.reload()},1500)},error:function(){Swal.fire("خطأ!","حدث خطأ أثناء التحديث","error")}})})}),$("#customer-name-input").on("input change",function(){var t=$(this).val(),e=$('#customers-list option[value="'+t+'"]');e.length>0?$("#customer-id-input").val(e.data("id")):$("#customer-id-input").val("")}),$(document).on("paste",function(t){var e=(t.clipboardData||t.originalEvent.clipboardData).items;for(var a in e){var o=e[a];if(o.kind==="file"&&o.type.indexOf("image/")!==-1){var r=o.getAsFile(),n=new File([r],"pasted-image.png",{type:r.type});let i=new DataTransfer;i.items.add(n),$("#image-upload")[0].files=i.files;var s=new FileReader;s.onload=function(c){$("#pasted-image-preview img").attr("src",c.target.result),$("#pasted-image-preview").show()},s.readAsDataURL(r),toastr.success("تم لصق الصورة بنجاح!","نجاح")}}}),$("#image-upload").on("change",function(){if(this.files&&this.files[0]){var t=new FileReader;t.onload=function(e){$("#pasted-image-preview img").attr("src",e.target.result),$("#pasted-image-preview").show()},t.readAsDataURL(this.files[0])}});var d=$("#drop-zone");$(document).on("drag dragstart dragend dragover dragenter dragleave drop",function(t){t.preventDefault(),t.stopPropagation()}),d.on("dragover dragenter",function(){$(this).css({background:"#e3f2fd","border-color":"#7367F0"})}),d.on("dragleave dragend drop",function(){$(this).css({background:"#f9f9f9","border-color":"#ccc"})}),d.on("drop",function(t){var e=t.originalEvent.dataTransfer.files;if(e.length>0){var a=e[0];if(a.type.indexOf("image/")!==-1){let r=new DataTransfer;r.items.add(a),$("#image-upload")[0].files=r.files;var o=new FileReader;o.onload=function(n){$("#pasted-image-preview img").attr("src",n.target.result),$("#pasted-image-preview").show()},o.readAsDataURL(a),toastr.success("تم إضافة الصورة بنجاح!","نجاح")}else toastr.error("يرجى اختيار صورة فقط","خطأ")}}),d.on("click",function(t){t.target.tagName!=="INPUT"&&$("#image-upload").click()});var h=window.laserConfig.costs.operating,C=window.laserConfig.costs.ceylon;$(document).on("input","#required-pieces-input, #pps-input",function(){var t=parseFloat($("#required-pieces-input").val()),e=parseFloat($("#pps-input").val());if(t>0&&e>0){var a=Math.ceil(t/e),o=$("#sc-input");o.val()!=a&&(o.val(a),o.removeClass("flash-input"),o.get(0).offsetWidth,o.addClass("flash-input"),setTimeout(function(){o.removeClass("flash-input")},1e3))}p()});function p(){var t=parseFloat($("#height-input").val())||0,e=$("#source-select").val(),a=parseFloat($("#material-select").find(":selected").data("price"))||0,o=$("#ceylonSwitch").is(":checked"),r=parseInt($("#pps-input").val())||1,n=parseInt($("#required-pieces-input").val())||0,s=$("#custom-operating-cost-input").val(),i=s!==""&&s!==void 0?parseFloat(s):h;r<1&&(r=1);var c=Math.ceil(n/r),u=t/100,g=0,f=0;e==="ap_group"&&(f=u*a,o&&(f+=u*C),g=f/r);var x=g+i,v=f+i*r,y=v*c;$("#piece-cost").text(x.toFixed(2)),$("#section-cost").text(v.toFixed(2)),$("#section-count-display").text(c),$("#approx-cost").text(y.toFixed(2))}$(".calc-input, #source-select, #material-select, #ceylonSwitch").on("change keyup",p),$("#saveOrderBtn").on("click",function(){var t=new FormData($("#laserOrderForm")[0]);$.ajax({url:window.laserConfig.routes.store,type:"POST",data:t,processData:!1,contentType:!1,success:function(e){$("#addOrderModal").modal("hide"),toastr.success("تمت الإضافة بنجاح"),location.reload()},error:function(e){toastr.error("يرجى التأكد من البيانات")}})}),window.deleteLaserOrder=function(t){Swal.fire({title:"هل أنت متأكد؟",text:"سيتم حذف هذا الطلب نهائياً",type:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"نعم، احذف",cancelButtonText:"إلغاء"}).then(e=>{e.value&&$.ajax({url:window.laserConfig.routes.delete+t,type:"DELETE",data:{_token:window.laserConfig.csrfToken},success:function(){Swal.fire("تم الحذف!","تم حذف الطلب بنجاح","success"),l.row($('tr[data-id="'+t+'"]')).remove().draw()},error:function(){Swal.fire("خطأ!","حدث خطأ أثناء الحذف","error")}})})},window.editLaserOrder=function(t){$.get(window.laserConfig.routes.show+t,function(e){$("#customer-name-input").val(e.customer?e.customer.name:""),$("#customer-id-input").val(e.customer_id||""),$("#source-select").val(e.source),$("#material-select").val(e.material_id||""),$("#ceylonSwitch").prop("checked",e.add_ceylon),$("#height-input").val(e.height),$("#width-input").val(e.width),$("#required-pieces-input").val(e.required_pieces),$("#pps-input").val(e.pieces_per_section),$("#sc-input").val(e.section_count),$("#custom-operating-cost-input").val(e.custom_operating_cost),$('#laserOrderForm textarea[name="notes"]').val(e.notes),$("#addOrderModal .modal-title").text("تعديل الطلب"),$("#saveOrderBtn").text("تحديث").off("click").on("click",function(){var a=new FormData($("#laserOrderForm")[0]);$.ajax({url:window.laserConfig.routes.update+t,type:"POST",data:a,processData:!1,contentType:!1,headers:{"X-CSRF-TOKEN":window.laserConfig.csrfToken,"X-HTTP-Method-Override":"PUT"},success:function(o){$("#addOrderModal").modal("hide"),toastr.success("تم التحديث بنجاح"),setTimeout(function(){location.reload()},1e3)},error:function(o){toastr.error("يرجى التأكد من البيانات")}})}),$("#addOrderModal").modal("show"),p()}).fail(function(){toastr.error("حدث خطأ أثناء تحميل البيانات")})},window.restartLaserOrder=function(t){Swal.fire({title:"إعادة تشغيل الطلب؟",text:"سيتم إنشاء نسخة جديدة من هذا الطلب",type:"question",showCancelButton:!0,confirmButtonColor:"#7367F0",cancelButtonColor:"#6c757d",confirmButtonText:"نعم، أعد التشغيل",cancelButtonText:"إلغاء"}).then(e=>{e.value&&$.ajax({url:window.laserConfig.routes.restart+t,type:"POST",data:{_token:window.laserConfig.csrfToken},success:function(){Swal.fire("تم!","تم إعادة تشغيل الطلب بنجاح","success"),setTimeout(function(){location.reload()},1500)},error:function(){Swal.fire("خطأ!","حدث خطأ أثناء إعادة التشغيل","error")}})})},$("#addOrderModal").on("hidden.bs.modal",function(){$("#laserOrderForm")[0].reset(),$("#customer-id-input").val(""),$("#custom-operating-cost-input").val(""),$("#addOrderModal .modal-title").text("طلب ليزر جديد"),$("#saveOrderBtn").text("حفظ"),$("#saveOrderBtn").off("click").on("click",m)}),$(".modal .close, .modal .btn-secondary").on("click",function(){$("#addOrderModal").modal("hide")});function m(){var t=new FormData($("#laserOrderForm")[0]);$.ajax({url:window.laserConfig.routes.store,type:"POST",data:t,processData:!1,contentType:!1,success:function(e){$("#addOrderModal").modal("hide"),toastr.success("تمت الإضافة بنجاح"),setTimeout(function(){location.reload()},1e3)},error:function(e){toastr.error("يرجى التأكد من البيانات")}})}$("#saveOrderBtn").on("click",m),$(document).on("click",".product-img img",function(){var t=$(this).attr("src");t&&($("#enlarged-image").attr("src",t),$("#imageZoomModal").modal("show"))}),$(".close-zoom").on("click",function(){$("#imageZoomModal").modal("hide")})});
