$(document).ready(function(){var p=$(".steps-validation").show();$(document).on("input","#data-required-pieces, #data-pieces-per-card",function(){var t=parseFloat($("#data-required-pieces").val()),e=parseFloat($("#data-pieces-per-card").val());if(t>0&&e>0){var a=Math.ceil(t/e),r=$("#data-cards-count");r.val()!=a&&(r.val(a),r.removeClass("flash-input"),r.closest(".form-control").get(0).offsetWidth,r.addClass("flash-input"),setTimeout(function(){r.removeClass("flash-input")},1e3))}}),$(".steps-validation").steps({headerTag:"h6",bodyTag:"fieldset",transitionEffect:"fade",titleTemplate:'<span class="step">#index#</span> #title#',labels:{finish:"Submit"},onStepChanging:function(t,e,a){return e>a?!0:(e<a&&(p.find(".body:eq("+a+") label.error").remove(),p.find(".body:eq("+a+") .error").removeClass("error")),p.validate().settings.ignore=":disabled,:hidden",p.valid())},onFinishing:function(t,e){return p.validate().settings.ignore=":disabled",p.valid()},onFinished:function(t,e){_()}}),$(".steps-validation").validate({ignore:"input[type=hidden]",errorClass:"danger",successClass:"success",highlight:function(t,e){$(t).removeClass(e)},unhighlight:function(t,e){$(t).removeClass(e)},errorPlacement:function(t,e){t.insertAfter(e)}});var u=$(".data-thumb-view").DataTable({responsive:!1,deferRender:!0,columnDefs:[{orderable:!0,targets:0,checkboxes:{selectRow:!0}}],dom:'<"top"<"actions action-btns"B><"action-filters"lf>><"clear">rt<"bottom"<"actions">p>',oLanguage:{sLengthMenu:"_MENU_",sSearch:""},aLengthMenu:[[4,10,15,20],[4,10,15,20]],select:{style:"multi"},order:[[1,"desc"]],bInfo:!1,pageLength:4,buttons:[{text:"<i class='feather icon-plus'></i> إضافة طلب جديد",action:function(t,e,a,r){$("#validation").slideToggle(function(){var s=$(this).is(":visible");e.button(a).text(s?'<i class="feather icon-x"></i> اغـــلاق':"<i class='feather icon-plus'></i> إضافة طلب جديد")})},className:"btn-outline-primary"}],initComplete:function(t,e){$(".dt-buttons .btn").removeClass("btn-secondary")}}),F=$(".actions-dropodown");F.insertBefore($(".top .actions .dt-buttons")),$(".data-items").length>0&&new PerfectScrollbar(".data-items",{wheelPropagation:!1}),$(".hide-data-sidebar, .cancel-data-btn, .overlay-bg").on("click",function(){$(".add-new-data").removeClass("show"),$(".overlay-bg").removeClass("show"),$("#data-name, #data-price").val(""),$("#data-category, #data-status").prop("selectedIndex",0)});var x=null;let w=1;$("#add-layer-btn").on("click",function(){var t=$("#layers-container .layer-row").first(),e=t.clone();e.find(".layer-size").attr("name","layers["+w+"][size]").val(""),e.find(".layer-count").attr("name","layers["+w+"][count]").val(""),$("#layers-container").append(e),w++}),$(document).on("click",".remove-layer-btn",function(){$("#layers-container .layer-row").length>1?$(this).closest(".layer-row").remove():$(this).closest(".layer-row").find("input, select").val("")}),$(document).on("paste",function(t){var e=(t.clipboardData||t.originalEvent.clipboardData).items;for(var a in e){var r=e[a];if(r.kind==="file"&&r.type.indexOf("image/")!==-1){var s=r.getAsFile(),l=new File([s],"pasted-image.png",{type:s.type});let o=new DataTransfer;o.items.add(l),$("#data-image-upload")[0].files=o.files;var c=new FileReader;c.onload=function(f){$("#pasted-image-preview img").attr("src",f.target.result),$("#pasted-image-preview").show()},c.readAsDataURL(s),toastr.success("Image pasted successfully!","Success")}}}),$("#data-image-upload").on("change",function(){if(this.files&&this.files[0]){var t=new FileReader;t.onload=function(e){$("#pasted-image-preview img").attr("src",e.target.result),$("#pasted-image-preview").show()},t.readAsDataURL(this.files[0])}});function _(){var t=new FormData,e=$("#data-customer").val(),a=$("#data-customer-view").val();if(!e){var r=$('#customers-list option[value="'+a+'"]');r.length>0&&(e=r.attr("data-id"))}t.append("customerId",e||""),t.append("height",$("#data-height").val()),t.append("width",$("#data-width").val()),t.append("cards_count",$("#data-cards-count").val()),t.append("pieces_per_card",$("#data-pieces-per-card").val()),t.append("notes",$("#data-notes").val()),$("#layers-container .layer-row").each(function(o,f){var v=$(f).find(".layer-size").val(),i=$(f).find(".layer-count").val();v&&i&&(t.append("layers["+o+"][size]",v),t.append("layers["+o+"][count]",i))}),t.append("_token",$('meta[name="csrf-token"]').attr("content"));var s=$("#data-image-upload")[0].files[0];s&&t.append("image",s);var l="/stras/store",c="POST";x&&(l="/stras/update/"+x,t.append("_method","PUT")),$.ajax({url:l,type:c,data:t,processData:!1,contentType:!1,success:function(o){console.log("Order saved:",o),Swal.fire({type:"success",title:"تم التسجيل بنجاح!",showConfirmButton:!1,timer:1500,buttonsStyling:!1,confirmButtonClass:"btn btn-primary"}),$("#validation").slideUp(),setTimeout(function(){location.reload()},1e3)},error:function(o){if(console.error("Error processing order:",o),o.status===422){var f=o.responseJSON.errors;$.each(f,function(v,i){toastr.error(i[0],"خطا")})}else toastr.error("Error processing order. Please try again.","خطا")}})}$(document).on("click",".status-toggle",function(t){t.stopPropagation();var e=$(this),a=e.closest("tr");a.find(".stras_id").val(),a.find(".order_id").val()}),window.editStras=function(t){x=t,$.get("/stras/show/"+t,function(e){$(".new-data-title h4").text("تعديل طلب"),$("#saveDataBtn").text("Update"),$("#data-customer").val(e.customerId),e.customer&&$("#data-customer-view").val(e.customer.name),$("#data-height").val(e.height),$("#data-width").val(e.width),$("#data-cards-count").val(e.cards_count),$("#data-pieces-per-card").val(e.pieces_per_card),$("#data-notes").val(e.notes),e.cards_count&&e.pieces_per_card&&$("#data-required-pieces").val(e.cards_count*e.pieces_per_card),$("#layers-container").empty(),e.layers&&e.layers.length>0?(e.layers.forEach(function(a,r){var s=`<div class="layer-row row mb-1">
                                        <div class="col-md-5">
                                            <div class="form-group">
                                                <label>المقاس</label>
                                                <select class="form-control layer-size" name="layers[${r}][size]">
                                                     // Need to have options. Cloning hidden template or similar is better, 
                                                     // but here we might loose options if we just string build.
                                                     // Better: Clone a template if possible, or fetch options earlier?
                                                     // Actually, let's use the first row logic if exists?
                                                     // Or just build options manually (Standard sizes).
                                                     <option value="6">6</option>
                                                     <option value="8">8</option>
                                                     <option value="10">10</option>
                                                     <option value="12">12</option>
                                                     // We should ideally use the sizes from blade...
                                                     // Let's rely on the fact that existing options are standard.
                                                     // Or better, grab options from a hidden select or just hardcode standard ones for now 
                                                     // as we don't have easy access to blade variable here in JS without passing it.
                                                     // Let's iterate options from existing select in DOM if available.
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <div class="form-group">
                                                <label>العدد</label>
                                                <input type="number" class="form-control layer-count" name="layers[${r}][count]" placeholder="عدد الحبات" value="${a.count}">
                                            </div>
                                        </div>
                                        <div class="col-md-2 d-flex align-items-center">
                                            <button type="button" class="btn btn-danger btn-icon remove-layer-btn"><i class="feather icon-trash"></i></button>
                                        </div>
                                    </div>`,l=$(s),c="";window.strasPrices&&window.strasPrices.forEach(function(o){o.type==="stras"&&(c+=`<option value="${o.size}">${o.size}</option>`)}),c===""&&(c='<option value="6">6</option><option value="8">8</option><option value="10">10</option><option value="12">12</option>'),l.find(".layer-size").html(c).val(a.size),$("#layers-container").append(l)}),w=e.layers.length):$("#add-layer-btn").trigger("click"),$("#validation").slideDown(),$("html, body").animate({scrollTop:$("#validation").offset().top},500)})},window.deleteStras=function(t){Swal.fire({title:"هل انت متأكد؟",text:"لن تتمكن من استرجاع هذا الطلب!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"نعم، احذفه!",cancelButtonText:"الغاء"}).then(e=>{e.value&&$.ajax({url:"/stras/delete/"+t,type:"DELETE",data:{_token:$('meta[name="csrf-token"]').attr("content")},success:function(a){Swal.fire("تم الحذف!","تم حذف الطلب بنجاح.","success").then(()=>{location.reload()})},error:function(a){Swal.fire("خطأ!","حدث خطأ اثناء الحذف.","error")}})})},window.restartStras=function(t){Swal.fire({title:"إعادة تشغيل؟",text:"سيتم إنشاء نسخة جديدة من هذا الطلب.",type:"question",showCancelButton:!0,confirmButtonText:"نعم، أعد التشغيل",cancelButtonText:"الغاء"}).then(e=>{e.value&&$.ajax({url:"/stras/restart/"+t,type:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content")},success:function(a){Swal.fire("تم!","تم إعادة تشغيل الطلب بنجاح.","success").then(()=>{location.reload()})},error:function(a){Swal.fire("خطأ!","حدث خطأ اثناء العملية.","error")}})})},$("#saveDataBtn").on("click",function(t){t.preventDefault(),_()}),u.on("select deselect",function(){var t=u.rows({selected:!0}).count();t>0&&$(".action-btns").show()}),$("#bulk-delete-btn").on("click",function(){var t=u.rows({selected:!0}).nodes(),e=[];$.each(t,function(a,r){var s=$(r).find(".stras_id").val();s&&e.push(s)}),e.length!==0&&Swal.fire({title:"هل انت متأكد؟",text:"سيتم حذف "+e.length+" طلب/طلبات ولن تستطيع استرجاعهم!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"نعم، احذف",cancelButtonText:"الغاء"}).then(a=>{a.value&&$.ajax({url:"/stras/bulk-delete",type:"POST",data:{ids:e,_token:$('meta[name="csrf-token"]').attr("content")},success:function(r){Swal.fire("تم الحذف!","تم حذف الطلبات المحددة بنجاح.","success").then(()=>{location.reload()})},error:function(r){Swal.fire("خطأ!","حدث خطأ اثناء الحذف.","error")}})})}),u.on("select deselect",function(t,e,a,r){a==="row"&&D()}),u.on("draw",function(){});function D(){var t={},e=0,a=0,r=0,s=0,l={stras:{},paper:{},global:{}};window.strasPrices&&window.strasPrices.forEach(function(n){if(n.type==="stras")l.stras[n.size]=parseFloat(n.price)||0;else if(n.type==="paper"){var d=n.size.replace(/\D/g,"");d&&(l.paper[d]=parseFloat(n.price)||0)}else n.type==="global"&&n.size==="operating_cost"&&(l.global.op_cost=parseFloat(n.price)||0)});function c(n){var d=Math.round(n);return l.paper[d]?l.paper[d]:0}var o=u.rows({selected:!0}).nodes(),f=o.length>0;$.each(o,function(n,d){var m=$(d),k=parseFloat(m.data("height"))||0,E=parseFloat(m.data("width"))||0,g=parseFloat(m.data("cards-count"))||0,S=parseFloat(m.data("pieces-per-card"))||0;g>0&&(e+=k*g/100),g>0&&S>0&&(a+=g*S);var b=0,O=c(E),R=k/100*O;b+=R;var j=l.global.op_cost||0;b+=j;var h=m.data("layers");if(h){if(typeof h=="string")try{h=JSON.parse(h)}catch{}$.each(h,function(q,z){var y=z.size,T=parseFloat(z.count)||0;t[y]||(t[y]=0),t[y]+=T;var I=l.stras[y]||0;b+=T*I})}var L=b*g;s+=L,r+=g});var v=$("#stras-calculator-results");if(f){var i="";if(e>0&&(i+='<span class="badge badge-info mb-1" style="font-size: 1em; margin-left:15px;"><i class="feather icon-maximize-2"></i>  طول الورق : '+e.toFixed(2)+" متر</span>"),a>0&&(i+='<span class="badge badge-warning mb-1" style="font-size: 1em; margin-left:15px;"><i class="feather icon-package"></i> اجمالي القطع : '+a+" </span>"),s>0)if(i+='<span class="badge badge-primary mb-1" style="font-size: 1em; margin-left:15px;"><i class="feather icon-dollar-sign"></i> الاجمالي : '+s.toFixed(2)+" جنيه</span>",r>0){var P=s/r;if(i+='<span class="badge badge-purple mb-1" style="font-size: 1em; margin-left:15px; background-color: #6f42c1; color:white;"><i class="feather icon-tag"></i> تكلفة الكارت : '+P.toFixed(3)+" جنيه</span>",a>0){var B=s/a;i+='<span class="badge badge-warning mb-1" style="font-size: 1em; margin-left:15px; background-color: #ff9f43; color:white;"><i class="feather icon-disc"></i> تكلفة القطعة : '+B.toFixed(4)+" جنيه</span>"}i+="<br>"}else i+="<br>";else(e>0||a>0)&&(i+="<br>");i+='<i class="feather icon-bar-chart-2"></i> اجمالي الاستراس: &nbsp;&nbsp;';var C=[];Object.keys(t).sort((n,d)=>n-d).forEach(function(n){C.push('<span class="badge badge-success" style="font-size: 1em; margin-left:5px;"> مقاس '+n+": "+t[n]+" </span>")}),C.length===0?i+="لا توجد طبقات محددة":i+=C.join(" "),v.html(i).slideDown()}else v.slideUp()}window.addToInvoice=function(){var t=u.rows({selected:!0}).nodes(),e=[];if($.each(t,function(a,r){var s=$(r).find(".stras_id").val();s&&e.push(s)}),e.length===0){toastr.warning("Please select items first");return}$.post("/invoices/add",{_token:$('meta[name="csrf-token"]').attr("content"),ids:e,type:"stras"},function(a){toastr.success("تمت الاضافة للفاتورة"),a.cart_count!==void 0&&($(".cart-item-count").text(a.cart_count),$(".badge.badge-up.cart-item-count").text(a.cart_count)),a.cart_html&&$("#cart-dropdown-items").html(a.cart_html)}).fail(function(){toastr.error("حدث خطأ")})}});
