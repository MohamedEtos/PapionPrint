$(document).ready(function(){var c=$(".steps-validation").show();$(".steps-validation").steps({headerTag:"h6",bodyTag:"fieldset",transitionEffect:"fade",titleTemplate:'<span class="step">#index#</span> #title#',labels:{finish:"Submit"},onStepChanging:function(t,e,s){return e>s?!0:(e<s&&(c.find(".body:eq("+s+") label.error").remove(),c.find(".body:eq("+s+") .error").removeClass("error")),c.validate().settings.ignore=":disabled,:hidden",c.valid())},onFinishing:function(t,e){return c.validate().settings.ignore=":disabled",c.valid()},onFinished:function(t,e){m()}}),$(".steps-validation").validate({ignore:"input[type=hidden]",errorClass:"danger",successClass:"success",highlight:function(t,e){$(t).removeClass(e)},unhighlight:function(t,e){$(t).removeClass(e)},errorPlacement:function(t,e){t.insertAfter(e)},rules:{email:{email:!0}}});var u=$(".data-thumb-view").DataTable({responsive:!1,deferRender:!0,columnDefs:[{orderable:!0,targets:0,checkboxes:{selectRow:!0}}],dom:'<"top"<"actions action-btns"B><"action-filters"lf>><"clear">rt<"bottom"<"actions">p>',oLanguage:{sLengthMenu:"_MENU_",sSearch:""},aLengthMenu:[[4,10,15,20],[4,10,15,20]],select:{style:"multi"},order:[[1,"desc"]],bInfo:!1,pageLength:4,buttons:[{text:"<i class='feather icon-plus'></i> تشفغيل خارجي",action:function(t,e,s,o){$("#validation").slideToggle(function(){var n=$(this).is(":visible");e.button(s).text(n?'<i class="feather icon-x"></i> اغـــلاق':"<i class='feather icon-plus'></i> تشفغيل خارجي")})},className:"btn-outline-primary"}],initComplete:function(t,e){$(".dt-buttons .btn").removeClass("btn-secondary")}});u.on("draw.dt",function(){setTimeout(function(){navigator.userAgent.indexOf("Mac OS X")!=-1&&$(".dt-checkboxes-cell input, .dt-checkboxes").addClass("mac-checkbox")},50)});var g=$(".actions-dropodown");g.insertBefore($(".top .actions .dt-buttons")),$(".data-items").length>0&&new PerfectScrollbar(".data-items",{wheelPropagation:!1}),$(".hide-data-sidebar, .cancel-data-btn, .overlay-bg").on("click",function(){$(".add-new-data").removeClass("show"),$(".overlay-bg").removeClass("show"),$("#data-name, #data-price").val(""),$("#data-category, #data-status").prop("selectedIndex",0)});var i=null,d=null;function b(){$("#data-customer, #data-customer-view, #data-fabric-type, #data-source, #data-code, #data-width, #data-paper-shield, #data-meters, #data-price, #data-notes").val(""),$("#data-status").val("بانتظار اجراء"),$("#data-payment-status").val("0"),$("#data-image-upload").val(""),i=null,d=null,$(".new-data-title h4").text("اضافه اذن تشغيل"),$("#saveDataBtn").text("Add Data")}function m(){console.log("Submitting Wizard Data"),console.log("Save/Update Data Button Clicked");var t=new FormData,e=$("#data-customer").val(),s=$("#data-customer-view").val();if(!e){var o=$("#data-customer-view").val(),n=$('#customers-list option[value="'+o+'"]');n.length>0&&(e=n.attr("data-id"))}t.append("customerId",e||""),t.append("customerName",s),t.append("fabrictype",$("#data-fabric-type").val()),t.append("fabricsrc",$("#data-source").val()),t.append("fabriccode",$("#data-code").val()),t.append("fabricwidth",$("#data-width").val()),t.append("papyershild",$("#data-paper-shield").val()),t.append("meters",$("#data-meters").val()),t.append("status",$("#data-status").val()),t.append("paymentstatus",$("#data-payment-status").val()),t.append("price",$("#data-price").val()),t.append("notes",$("#data-notes").val()),t.append("notes",$("#data-notes").val()),d&&t.append("orderId",d),t.append("_token",$('meta[name="csrf-token"]').attr("content"));var p=$("#data-image-upload")[0].files[0];p&&t.append("image",p);var a="/Rollpress/store",r="POST";i&&(a="/rollpress/update/"+i,t.append("_method","PUT")),$.ajax({url:a,type:r,data:t,processData:!1,contentType:!1,success:function(l){try{console.log("Order saved/updated:",l);var h=i?"Order Updated Successfully!":"Order Added Successfully!";if(Swal.fire({type:"success",title:"تم التسجيل بنجاح!",showConfirmButton:!1,timer:1500,buttonsStyling:!1,confirmButtonClass:"btn btn-primary"}),$("#validation").slideUp(),d){var f=$('input.order_id[value="'+d+'"]').closest("tr");u.row(f).remove().draw()}if(i){var f=$('input.roll_id[value="'+i+'"]').closest("tr");u.row(f).remove().draw()}}catch(v){console.error("Error updating UI:",v),toastr.warning("Order saved, but UI update encountered an issue. See console.","Warning")}finally{$(".add-new-data").removeClass("show"),$(".overlay-bg").removeClass("show"),b()}},error:function(l){if(console.error("Error processing order:",l),l.status===422){var h=l.responseJSON.errors;$.each(h,function(f,v){toastr.error(v[0],"خطا")})}else toastr.error("Error processing order. Please try again.","خطا")}})}$("#saveDataBtn").on("click",function(t){t.preventDefault(),m()}),$(document).on("click",".status-toggle",function(t){t.stopPropagation();var e=$(this),s=e.closest("tr"),o=s.find(".order_id").val(),n=e.find(".chip-text"),p=n.text().trim();if(p==="انتهت الطباعة"){s.fadeOut();return}if(o){if(p==="بانتظار اجراء"||p==="بدء التشغيل"){t.preventDefault(),$.ajax({url:"/printers/"+o,type:"GET",success:function(a){var r=a.rollpress?a.rollpress:a,l=a.customers?a.customers.name:"";$("#data-customer-view").val(l),$("#data-customer").val(a.customerId),$("#data-fabric-type").val(r.fabrictype||r.fabric_type||""),$("#data-source").val(r.fabricsrc||"العميل"),$("#data-code").val(r.fabriccode||""),$("#data-width").val(r.fabricwidth||a.fileWidth||""),$("#data-paper-shield").val(r.papyershild||""),$("#data-meters").val(r.meters||a.meters||""),$("#data-status").val(r.status&&r.status!=0?"تم الانتهاء":"جاري العمل"),a.rollpress?$("#data-status").val(r.status?"تم الانتهاء":"جاري العمل"):$("#data-status").val("جاري العمل"),$("#data-payment-status").val(r.paymentstatus||0),$("#data-price").val(r.price||a.totalPrice||""),!r.price&&a.printingprices&&$("#data-price").val(a.printingprices.totalPrice),$("#data-notes").val(r.notes||a.notes||""),a.rollpress?(i=a.rollpress.id,d=a.id,$(".new-data-title h4").text("تعديل طلب المكبس"),$("#saveDataBtn").text("حفظ التعديلات")):(i=null,d=a.id,$(".new-data-title h4").text("بدء تشغيل طلب جديد"),$("#saveDataBtn").text("بدء التشغيل")),$("#validation").slideDown(),$("html, body").animate({scrollTop:$("#validation").offset().top-100},500)},error:function(a){console.error("Error fetching order:",a),toastr.error("Could not fetch order details.","Error")}});return}$.ajax({url:"/printers/update-status/"+o,type:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content")},success:function(a){n.text(a.status),Swal.fire({title:" تحديث الحالة :"+a.status,text:"Status updated to "+a.status,type:"success",showConfirmButton:!1,timer:1e3,buttonsStyling:!1})},error:function(a){toastr.error("Failed to update status","Error",{showMethod:"fadeIn",hideMethod:"fadeOut"})}})}}),setInterval(function(){$("#validation").is(":visible")||location.reload()},3e4),u.on("select deselect",function(){var t=u.rows({selected:!0}).count();t>0&&$(".action-btns").show()}),window.addToInvoice=function(){var t=u.rows({selected:!0}).nodes(),e=[];if($.each(t,function(s,o){var n=$(o).find(".order_id").val();n&&e.push(n)}),e.length===0){toastr.warning("Please select items first");return}$.post("/invoices/add",{_token:$('meta[name="csrf-token"]').attr("content"),ids:e,type:"rollpress"},function(s){toastr.success("تمت الاضافة للفاتورة"),s.cart_count!==void 0&&($(".cart-item-count").text(s.cart_count),$(".badge.badge-up.cart-item-count").text(s.cart_count)),s.cart_html&&$("#cart-dropdown-items").html(s.cart_html)}).fail(function(){toastr.error("حدث خطأ")})}});
