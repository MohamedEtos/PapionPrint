$(document).ready(function(){var m=$(".steps-validation").show();$(document).on("input","#data-required-pieces, #data-pieces-per-card",function(){var a=parseFloat($("#data-required-pieces").val()),e=parseFloat($("#data-pieces-per-card").val());if(a>0&&e>0){var t=Math.ceil(a/e),r=$("#data-cards-count");r.val()!=t&&(r.val(t),r.removeClass("flash-input"),r.closest(".form-control").get(0).offsetWidth,r.addClass("flash-input"),setTimeout(function(){r.removeClass("flash-input")},1e3))}}),$(document).on("input","#data-customer-view",function(){var a=$(this).val(),e="",t=$("#customers-list option").filter(function(){return $(this).val()===a});t.length>0&&(e=t.attr("data-id")),$("#data-customer").val(e)}),$(".steps-validation").steps({headerTag:"h6",bodyTag:"fieldset",transitionEffect:"fade",titleTemplate:'<span class="step">#index#</span> #title#',labels:{finish:"Submit"},onStepChanging:function(a,e,t){return e>t?!0:(e<t&&(m.find(".body:eq("+t+") label.error").remove(),m.find(".body:eq("+t+") .error").removeClass("error")),m.validate().settings.ignore=":disabled,:hidden",m.valid())},onFinishing:function(a,e){return m.validate().settings.ignore=":disabled",m.valid()},onFinished:function(a,e){T()}}),$(".steps-validation").validate({ignore:"input[type=hidden]",errorClass:"danger",successClass:"success",highlight:function(a,e){$(a).removeClass(e)},unhighlight:function(a,e){$(a).removeClass(e)},errorPlacement:function(a,e){a.insertAfter(e)}});var h=$(".data-thumb-view").DataTable({responsive:!1,deferRender:!0,columnDefs:[{orderable:!0,targets:0,checkboxes:{selectRow:!0}}],dom:'<"top"<"actions action-btns"B><"action-filters"lf>><"clear">rt<"bottom"<"actions">p>',oLanguage:{sLengthMenu:"_MENU_",sSearch:""},aLengthMenu:[[4,10,15,20],[4,10,15,20]],select:{style:"multi"},order:[[1,"desc"]],bInfo:!1,pageLength:4,buttons:[{text:"<i class='feather icon-plus'></i> إضافة طلب جديد",action:function(a,e,t,r){$("#validation").slideToggle(function(){var s=$(this).is(":visible");e.button(t).text(s?'<i class="feather icon-x"></i> اغـــلاق':"<i class='feather icon-plus'></i> إضافة طلب جديد")})},className:"btn-outline-primary"}],initComplete:function(a,e){$(".dt-buttons .btn").removeClass("btn-secondary")}}),E=$(".actions-dropodown");E.insertBefore($(".top .actions .dt-buttons")),$(".data-items").length>0&&new PerfectScrollbar(".data-items",{wheelPropagation:!1}),$(".hide-data-sidebar, .cancel-data-btn, .overlay-bg").on("click",function(){$(".add-new-data").removeClass("show"),$(".overlay-bg").removeClass("show"),$("#data-name, #data-price").val(""),$("#data-category, #data-status").prop("selectedIndex",0)});var k=null;let x=1;$("#add-layer-btn").on("click",function(){var a=$("#layers-container .layer-row").first(),e=a.clone();e.find(".layer-size").attr("name","layers["+x+"][size]").val(""),e.find(".layer-count").attr("name","layers["+x+"][count]").val(""),$("#layers-container").append(e),x++}),$(document).on("click",".remove-layer-btn",function(){$("#layers-container .layer-row").length>1?$(this).closest(".layer-row").remove():$(this).closest(".layer-row").find("input, select").val("")}),$(document).on("paste",function(a){var e=(a.clipboardData||a.originalEvent.clipboardData).items;for(var t in e){var r=e[t];if(r.kind==="file"&&r.type.indexOf("image/")!==-1){var s=r.getAsFile(),c=new File([s],"pasted-image.png",{type:s.type});let l=new DataTransfer;l.items.add(c),$("#data-image-upload")[0].files=l.files;var f=new FileReader;f.onload=function(w){$("#pasted-image-preview img").attr("src",w.target.result),$("#pasted-image-preview").show()},f.readAsDataURL(s),toastr.success("Image pasted successfully!","Success")}}}),$("#data-image-upload").on("change",function(){if(this.files&&this.files[0]){var a=new FileReader;a.onload=function(e){$("#pasted-image-preview img").attr("src",e.target.result),$("#pasted-image-preview").show()},a.readAsDataURL(this.files[0])}});function T(){var a=new FormData,e=$("#data-customer").val(),t=$("#data-customer-view").val();if(!e&&t){var r=$("#customers-list option").filter(function(){return $(this).val()===t});r.length>0&&(e=r.attr("data-id"))}a.append("customerId",e||""),a.append("customer_name",t),a.append("height",$("#data-height").val()),a.append("width",$("#data-width").val()),a.append("cards_count",$("#data-cards-count").val()),a.append("pieces_per_card",$("#data-pieces-per-card").val()),a.append("notes",$("#data-notes").val());var s=parseFloat($("#data-height").val())||0,c=parseFloat($("#data-width").val())||0,f=parseFloat($("#data-pieces-per-card").val())||0,l={stras:{},paper:{},global:{}};window.strasPrices&&window.strasPrices.forEach(function(o){if(o.type==="stras")l.stras[o.size]=parseFloat(o.price)||0;else if(o.type==="paper"){var n=o.size.replace(/\D/g,"");n&&(l.paper[n]=parseFloat(o.price)||0)}else o.type==="global"&&o.size==="operating_cost"&&(l.global.op_cost=parseFloat(o.price)||0)});var w=Math.round(c),C=l.paper[w]||0,d=s/100*C,S=l.global.op_cost||0,_=0;$("#layers-container .layer-row").each(function(o,n){var v=$(n).find(".layer-size").val(),p=parseFloat($(n).find(".layer-count").val())||0;if(v&&p){var P=l.stras[v]||0;_+=p*P}});var b=d+S+_,i=f>0?b/f:0;a.append("manufacturing_cost",i.toFixed(4)),$("#layers-container .layer-row").each(function(o,n){var v=$(n).find(".layer-size").val(),p=$(n).find(".layer-count").val();v&&p&&(a.append("layers["+o+"][size]",v),a.append("layers["+o+"][count]",p))}),a.append("_token",$('meta[name="csrf-token"]').attr("content"));var u=$("#data-image-upload")[0].files[0];u&&a.append("image",u);var g="/stras/store",z="POST";k&&(g="/stras/update/"+k,a.append("_method","PUT")),$.ajax({url:g,type:z,data:a,processData:!1,contentType:!1,success:function(o){console.log("Order saved:",o),Swal.fire({type:"success",title:"تم التسجيل بنجاح!",showConfirmButton:!1,timer:1500,buttonsStyling:!1,confirmButtonClass:"btn btn-primary"}),$("#validation").slideUp(),setTimeout(function(){location.reload()},1e3)},error:function(o){if(console.error("Error processing order:",o),o.status===422){var n=o.responseJSON.errors;$.each(n,function(v,p){toastr.error(p[0],"خطا")})}else toastr.error("Error processing order. Please try again.","خطا")}})}$(document).on("click",".status-toggle",function(a){a.stopPropagation();var e=$(this),t=e.closest("tr");t.find(".stras_id").val(),t.find(".order_id").val()}),window.editStras=function(a){k=a,$.get("/stras/show/"+a,function(e){$(".new-data-title h4").text("تعديل طلب"),$("#saveDataBtn").text("Update"),$("#data-customer").val(e.customerId),e.customer&&$("#data-customer-view").val(e.customer.name),$("#data-height").val(e.height),$("#data-width").val(e.width),$("#data-cards-count").val(e.cards_count),$("#data-pieces-per-card").val(e.pieces_per_card),$("#data-notes").val(e.notes),e.cards_count&&e.pieces_per_card&&$("#data-required-pieces").val(e.cards_count*e.pieces_per_card),$("#layers-container").empty(),e.layers&&e.layers.length>0?(e.layers.forEach(function(t,r){var s=`<div class="layer-row row mb-1">
                                        <div class="col-md-5">
                                            <div class="form-group">
                                                <label>المقاس</label>
                                                <select class="form-control layer-size" name="layers[${r}][size]">
                                                     // Need to have options. Cloning hidden template or similar is better, 
                                                     // but here we might loose options if we just string build.
                                                     // Better: Clone a template if possible, or fetch options earlier?
                                                     // Actually, let's use the first row logic if exists?
                                                     // Or just build options manually (Standard sizes).
                                                     <option value="6">6</option>
                                                     <option value="8">8</option>
                                                     <option value="10">10</option>
                                                     <option value="12">12</option>
                                                     // We should ideally use the sizes from blade...
                                                     // Let's rely on the fact that existing options are standard.
                                                     // Or better, grab options from a hidden select or just hardcode standard ones for now 
                                                     // as we don't have easy access to blade variable here in JS without passing it.
                                                     // Let's iterate options from existing select in DOM if available.
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <div class="form-group">
                                                <label>العدد</label>
                                                <input type="number" class="form-control layer-count" name="layers[${r}][count]" placeholder="عدد الحبات" value="${t.count}">
                                            </div>
                                        </div>
                                        <div class="col-md-2 d-flex align-items-center">
                                            <button type="button" class="btn btn-danger btn-icon remove-layer-btn"><i class="feather icon-trash"></i></button>
                                        </div>
                                    </div>`,c=$(s),f="";window.strasPrices&&window.strasPrices.forEach(function(l){l.type==="stras"&&(f+=`<option value="${l.size}">${l.size}</option>`)}),f===""&&(f='<option value="6">6</option><option value="8">8</option><option value="10">10</option><option value="12">12</option>'),c.find(".layer-size").html(f).val(t.size),$("#layers-container").append(c)}),x=e.layers.length):$("#add-layer-btn").trigger("click"),$("#validation").slideDown(),$("html, body").animate({scrollTop:$("#validation").offset().top},500)})},window.deleteStras=function(a){Swal.fire({title:"هل انت متأكد؟",text:"لن تتمكن من استرجاع هذا الطلب!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"نعم، احذفه!",cancelButtonText:"الغاء"}).then(e=>{e.value&&$.ajax({url:"/stras/delete/"+a,type:"DELETE",data:{_token:$('meta[name="csrf-token"]').attr("content")},success:function(t){Swal.fire("تم الحذف!","تم حذف الطلب بنجاح.","success").then(()=>{location.reload()})},error:function(t){Swal.fire("خطأ!","حدث خطأ اثناء الحذف.","error")}})})},window.restartStras=function(a){Swal.fire({title:"إعادة تشغيل؟",text:"سيتم إنشاء نسخة جديدة من هذا الطلب.",type:"question",showCancelButton:!0,confirmButtonText:"نعم، أعد التشغيل",cancelButtonText:"الغاء"}).then(e=>{e.value&&$.ajax({url:"/stras/restart/"+a,type:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content")},success:function(t){Swal.fire("تم!","تم إعادة تشغيل الطلب بنجاح.","success").then(()=>{location.reload()})},error:function(t){Swal.fire("خطأ!","حدث خطأ اثناء العملية.","error")}})})},$("#saveDataBtn").on("click",function(a){a.preventDefault(),T()}),h.on("select deselect",function(){var a=h.rows({selected:!0}).count();a>0&&$(".action-btns").show()}),$("#bulk-delete-btn").on("click",function(){var a=h.rows({selected:!0}).nodes(),e=[];$.each(a,function(t,r){var s=$(r).find(".stras_id").val();s&&e.push(s)}),e.length!==0&&Swal.fire({title:"هل انت متأكد؟",text:"سيتم حذف "+e.length+" طلب/طلبات ولن تستطيع استرجاعهم!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"نعم، احذف",cancelButtonText:"الغاء"}).then(t=>{t.value&&$.ajax({url:"/stras/bulk-delete",type:"POST",data:{ids:e,_token:$('meta[name="csrf-token"]').attr("content")},success:function(r){Swal.fire("تم الحذف!","تم حذف الطلبات المحددة بنجاح.","success").then(()=>{location.reload()})},error:function(r){Swal.fire("خطأ!","حدث خطأ اثناء الحذف.","error")}})})}),h.on("select deselect",function(a,e,t,r){t==="row"&&O()}),h.on("draw",function(){});function O(){var a={},e=0,t=0,r=0,s=0,c={stras:{},paper:{},global:{}};window.strasPrices&&window.strasPrices.forEach(function(i){if(i.type==="stras")c.stras[i.size]=parseFloat(i.price)||0;else if(i.type==="paper"){var u=i.size.replace(/\D/g,"");u&&(c.paper[u]=parseFloat(i.price)||0)}else i.type==="global"&&i.size==="operating_cost"&&(c.global.op_cost=parseFloat(i.price)||0)});function f(i){var u=Math.round(i);return c.paper[u]?c.paper[u]:0}var l=h.rows({selected:!0}).nodes(),w=l.length>0;$.each(l,function(i,u){var g=$(u),z=parseFloat(g.data("height"))||0,o=parseFloat(g.data("width"))||0,n=parseFloat(g.data("cards-count"))||0,v=parseFloat(g.data("pieces-per-card"))||0;n>0&&(e+=z*n/100),n>0&&v>0&&(t+=n*v);var p=0,P=f(o),R=z/100*P;p+=R;var j=c.global.op_cost||0;p+=j;var y=g.data("layers");if(y){if(typeof y=="string")try{y=JSON.parse(y)}catch{}$.each(y,function(M,D){var F=D.size,B=parseFloat(D.count)||0;a[F]||(a[F]=0),a[F]+=B;var q=c.stras[F]||0;p+=B*q})}var L=p*n;s+=L,r+=n});var C=$("#stras-calculator-results");if(w){var d="";if(e>0&&(d+='<span class="badge badge-info mb-1" style="font-size: 1em; margin-left:15px;"><i class="feather icon-maximize-2"></i>  طول الورق : '+e.toFixed(2)+" متر</span>"),t>0&&(d+='<span class="badge badge-warning mb-1" style="font-size: 1em; margin-left:15px;"><i class="feather icon-package"></i> اجمالي القطع : '+t+" </span>"),s>0)if(d+='<span class="badge badge-primary mb-1" style="font-size: 1em; margin-left:15px;"><i class="feather icon-dollar-sign"></i> الاجمالي : '+s.toFixed(2)+" جنيه</span>",r>0){var S=s/r;if(d+='<span class="badge badge-purple mb-1" style="font-size: 1em; margin-left:15px; background-color: #6f42c1; color:white;"><i class="feather icon-tag"></i> تكلفة الكارت : '+S.toFixed(3)+" جنيه</span>",t>0){var _=s/t;d+='<span class="badge badge-warning mb-1" style="font-size: 1em; margin-left:15px; background-color: #ff9f43; color:white;"><i class="feather icon-disc"></i> تكلفة القطعة : '+_.toFixed(4)+" جنيه</span>"}d+="<br>"}else d+="<br>";else(e>0||t>0)&&(d+="<br>");d+='<i class="feather icon-bar-chart-2"></i> اجمالي الاستراس: &nbsp;&nbsp;';var b=[];Object.keys(a).sort((i,u)=>i-u).forEach(function(i){b.push('<span class="badge badge-success" style="font-size: 1em; margin-left:5px;"> مقاس '+i+": "+a[i]+" </span>")}),b.length===0?d+="لا توجد طبقات محددة":d+=b.join(" "),C.html(d).slideDown()}else C.slideUp()}window.addToInvoice=function(){var a=h.rows({selected:!0}).nodes(),e=[];if($.each(a,function(t,r){var s=$(r).find(".stras_id").val();s&&e.push(s)}),e.length===0){toastr.warning("Please select items first");return}$.post("/invoices/add",{_token:$('meta[name="csrf-token"]').attr("content"),ids:e,type:"stras"},function(t){toastr.success("تمت الاضافة للفاتورة"),t.cart_count!==void 0&&($(".cart-item-count").text(t.cart_count),$(".badge.badge-up.cart-item-count").text(t.cart_count)),t.cart_html&&$("#cart-dropdown-items").html(t.cart_html)}).fail(function(){toastr.error("حدث خطأ")})}});
