$(document).ready(function(){$("#data-copies, #data-height,  #data-price ,#data-pic-copies").on("input",function(){var a=parseFloat($("#data-copies").val())||0,e=parseFloat($("#data-height").val())||0,r=parseFloat($("#data-price").val())||0,s=a*e;$("#data-meters").val(s/100);var t=s*r;$("#data-total").val(t);var n=parseFloat($("#data-pic-copies").val())||0,l=parseFloat(170)||0,i=a*n,r=e/100/n*l;$("#data-price-pic").text(r),$("#data-total-pic").text(i),a>0&&e>0?$("#data-meters").prop("disabled",!0):$("#data-meters").prop("disabled",!1)}),$("#data-machine").on("change",function(){var a=$(this).find("option:selected").text().toLowerCase();a.includes("dtf")?($("#data-width").val(58),$("#data-pass").val(4).prop("disabled",!1)):a.includes("sublimation")?($("#data-width").val(150),$("#data-pass").val(1).prop("disabled",!0)):$("#data-pass").prop("disabled",!1)});var b=null;function B(){$("#data-customer, #data-customer-view, #data-machine, #data-height, #data-width, #data-copies, #data-pic-copies, #data-pass, #data-meters, #data-price, #data-notes, #data-fabric-type").val(""),$("#data-status").val("waiting"),$("#data-pass").val("1"),v=[],typeof d<"u"&&d&&d.removeAllFiles(),b=null,$(".new-data-title h4").text("اضافه اذن تشغيل"),$("#saveDataBtn").text("Add Data")}Dropzone.autoDiscover=!1;var v=[];Dropzone.instances.length>0&&Dropzone.instances.forEach(a=>a.destroy());try{var d=new Dropzone("#dataListUpload",{url:"/printers/upload-image",paramName:"file",maxFiles:10,acceptedFiles:".jpg,.jpeg,.png,.gif,.tiff,.tif,.webp",addRemoveLinks:!0,resizeHeight:110,resizeMimeType:"image/webp",resizeQuality:.9,headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},success:function(a,e){a.serverFileName=e.path,v.push(e.path),console.log("Images uploaded:",v),toastr.success("Image uploaded successfully")},removedfile:function(a){a.previewElement!=null&&a.previewElement.parentNode!=null&&a.previewElement.parentNode.removeChild(a.previewElement);var e=a.serverFileName;if(e){var s=v.indexOf(e);s!==-1&&(v.splice(s,1),console.log("Image removed. Remaining:",v))}return _updateMaxFilesReachedClass()},error:function(a,e){toastr.error("Upload failed:",e.message)}})}catch(a){toastr.error("Dropzone init warning:",a)}document.onpaste=function(a){for(var e=(a.clipboardData||a.originalEvent.clipboardData).items,s=0;s<e.length;s++){var t=e[s];t.kind==="file"&&d.addFile(t.getAsFile())}},$(document).on("click",".action-edit",function(a){a.stopPropagation();var e=$(this).closest("tr"),s=e.find(".order_id").val();s&&$.ajax({url:"/printers/"+s,type:"GET",success:function(t){$("#data-customer-view").val(t.customers?t.customers.name:""),$("#data-machine").val(t.machineId),$("#data-height").val(t.fileHeight),$("#data-width").val(t.fileWidth),$("#data-copies").val(t.fileCopies),$("#data-pic-copies").val(t.picInCopies),$("#data-fabric-type").val(t.fabric_type),$("#data-pass").val(t.pass),$("#data-meters").val(t.meters),$("#data-status").val(t.status),t.printingprices&&$("#data-price").val(t.printingprices.totalPrice),$("#data-notes").val(t.notes),v=[],typeof d<"u"&&d&&(d.removeAllFiles(!0),t.orders_imgs&&t.orders_imgs.length>0&&t.orders_imgs.forEach(function(r){var w={name:"Image",size:12345,serverFileName:r.path};d.emit("addedfile",w),d.emit("thumbnail",w,"/storage/"+r.path),d.emit("complete",w),d.files.push(w),v.push(r.path)}));var n=parseFloat($("#data-copies").val())||0,l=parseFloat($("#data-pic-copies").val())||0,i=n*l;$("#data-total-pic").text(i),b=t.id,$(".new-data-title h4").text("تعديل البيانات"),$("#saveDataBtn").text("حفظ التعديلات"),$(".add-new-data").addClass("show"),$(".overlay-bg").addClass("show")},error:function(t){console.error("Error fetching order:",t),toastr.error("Could not fetch order details.","Error")}})}),$(document).on("click",".action-delete",function(a){a.stopPropagation();var e=$(this).closest("td").parent("tr"),s=e.find(".order_id").val();if(console.log(s),!s){e.fadeOut();return}Swal.fire({title:"هل انت متاكد?",text:"لن تتمكن من التراجع عن هذا!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"نعم، احذفه!",confirmButtonClass:"btn btn-primary",cancelButtonClass:"btn btn-danger ml-1",buttonsStyling:!1}).then(function(t){t.value&&$.ajax({url:"/printers/delete/"+s,type:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content")},success:function(n){console.log("Order deleted:",n),e.fadeOut(function(){$(this).remove()}),Swal.fire({type:"success",title:"تم الحذف!",showConfirmButton:!1,timer:1500,buttonsStyling:!1,confirmButtonClass:"btn btn-primary"})},error:function(n){console.error("Error deleting order:",n),Swal.fire({title:"Error!",text:"Error deleting order. Please try again.",type:"error",confirmButtonClass:"btn btn-primary",buttonsStyling:!1})}})})}),$(".hide-data-sidebar, .cancel-data-btn, .overlay-bg").on("click",function(a){a.stopPropagation(),$(".add-new-data").removeClass("show"),$(".overlay-bg").removeClass("show"),B()}),$("#saveDataBtn").on("click",function(a){a.preventDefault(),console.log("Save/Update Data Button Clicked");var e=$("#data-customer-view").val(),s=$("#data-machine").val(),t=$("#data-height").val(),n=$("#data-width").val(),l=$("#data-copies").val(),i=$("#data-pic-copies").val(),r=$("#data-pass").val(),w=$("#data-meters").val(),C=$("#data-status").val(),S=$("#data-fabric-type").val(),m=$("#data-price").val();$("#data-fabric-type").val();var p=$("#data-notes").val(),u="/printers/store",f="POST",h={customerId:e,machineId:s,fileHeight:t,fileWidth:n,fileCopies:l,picInCopies:i,pass:r,meters:w,status:C,price:m,fabric_type:S,notes:p,image_paths:v,_token:$('meta[name="csrf-token"]').attr("content")};b&&(u="/printers/"+b,h._method="PUT",h.auto_advance_status=!0),$.ajax({url:u,type:f,data:h,success:function(c){try{console.log("Order saved/updated:",c);var g=b?"Order Updated Successfully!":"Order Added Successfully!";if(toastr.success(g,"تمت العملية بنجاح"),!c||!c.order){console.warn("Response missing 'order' object:",c);return}var o=c.order,k=o.customers?o.customers.name:"Unknown",I=o.machines?o.machines.name:"Unknown",E=o.printingprices?o.printingprices.pricePerMeter:"",F=o.orders_imgs&&o.orders_imgs.length>0?"/storage/"+o.orders_imgs[0].path:"/core/images/elements/apple-watch.png";if(b){var y=$('input.order_id[value="'+b+'"]').closest("tr");if(y.length){y.find(".product-img img").attr("src",F),y.find(".product-name").text(k);var _=y.find("td").eq(3);_.text(I+" "+o.pass+" pass");var T=y.find("td").eq(4);T.html("<b>"+o.meters+"</b>"),y.find(".chip-text").text(o.status),y.find(".chip").removeClass("chip-success chip-warning").addClass(o.status=="انتهت الطباعة"?"chip-success":"chip-info"),y.find("td:eq(6)").text(E)}}else{var D=`
                        <tr>
                            <td></td>
                            <td class="product-img">
                                <input type="hidden" class="order_id" value="${o.id}">
                                <img src="${F}" alt="Img placeholder">
                            </td>
                            <td class="product-name">${k}</td>
                            <td class="product-category">${I} ${o.pass} pass</td>
                            <td class="product-category"><b>${o.meters}</b></td>
                            <td>
                                <div class="chip chip-${o.status=="انتهت الطباعة"?"success":"info"}">
                                    <div class="chip-body status-toggle" style="cursor: pointer">
                                        <div class="chip-text">${o.status}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="product-price" title="Just now">الآن</td>
                            <td class="product-action">
                                <span class=" hover_action action-edit "><i class="feather icon-edit"></i></span>
                                <span class=" hover_action action-delete text-danger " ><i class="feather icon-trash"></i></span>
                            </td>
                        </tr>
                    `;$("table.data-thumb-view tbody").append(D)}}catch(O){console.error("Error updating UI:",O),toastr.warning("Order saved, but UI update encountered an issue. Please refresh.","Warning")}finally{$(".add-new-data").removeClass("show"),$(".overlay-bg").removeClass("show"),B()}},error:function(c){if(console.error("Error processing order:",c),c.status===422){var g=c.responseJSON.errors;$.each(g,function(o,k){toastr.error(k[0],"خطا")})}else toastr.error("Error processing order. Please try again.","خطا")}})}),$(document).on("click",".status-toggle",function(a){a.stopPropagation();var e=$(this),s=e.closest("tr"),t=s.find(".order_id").val(),n=e.find(".chip-text"),l=n.text().trim();if(l==="انتهت الطباعة"){s.fadeOut();return}if(t){if(l==="بانتظار اجراء"||l==="بانتظار اجراء"){a.preventDefault(),$.ajax({url:"/printers/"+t,type:"GET",success:function(i){$("#data-customer-view").val(i.customers?i.customers.name:""),$("#data-machine").val(i.machineId),$("#data-height").val(i.fileHeight),$("#data-width").val(i.fileWidth),$("#data-copies").val(i.fileCopies),$("#data-pic-copies").val(i.picInCopies),$("#data-pass").val(i.pass),$("#data-meters").val(i.meters),$("#data-fabric-type").val(i.fabric_type),$("#data-status").val(i.status),i.printingprices&&$("#data-price").val(i.printingprices.totalPrice),$("#data-notes").val(i.notes),b=i.id,$(".new-data-title h4").text("تحديث الطلب وبدات الطباعة"),$("#saveDataBtn").text("تحديث وبدء"),$(".add-new-data").addClass("show"),$(".overlay-bg").addClass("show")},error:function(i){console.error("Error fetching order:",i),toastr.error("Could not fetch order details.","Error")}});return}$.ajax({url:"/printers/update-status/"+t,type:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content")},success:function(i){n.text(i.status),Swal.fire({title:" تحديث الحالة :"+i.status,text:"Status updated to "+i.status,type:"success",showConfirmButton:!1,timer:1e3,buttonsStyling:!1})},error:function(i){toastr.error("Failed to update status","Error",{showMethod:"fadeIn",hideMethod:"fadeOut"})}})}});var x=$(".data-thumb-view").DataTable();if($(".actions-dropodown").hide(),x.on("select deselect",function(){var a=x.rows({selected:!0}).count();a>0?$(".actions-dropodown").slideDown():$(".actions-dropodown").slideUp()}),$(document).on("click",".bulk-delete-btn",function(a){a.preventDefault();var e=x.rows({selected:!0}),s=[];if(e.nodes().each(function(t){var n=$(t).find(".order_id").val();n&&s.push(n)}),s.length===0){Swal.fire({title:"تنبيه",text:"الرجاء تحديد طلب واحد على الأقل للحذف.",type:"warning",confirmButtonClass:"btn btn-primary",buttonsStyling:!1});return}Swal.fire({title:"هل انت متاكد من حذف "+s.length+" طلب؟",text:"لن تتمكن من التراجع عن هذا!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"نعم، احذفهم!",confirmButtonClass:"btn btn-primary",cancelButtonClass:"btn btn-danger ml-1",buttonsStyling:!1}).then(function(t){t.value&&$.ajax({url:"/printers/bulk-delete",type:"POST",data:{ids:s,_token:$('meta[name="csrf-token"]').attr("content")},success:function(n){e.remove().draw(),$(".actions-dropodown").hide(),Swal.fire({type:"success",title:"تم الحذف!",text:"تم حذف الطلبات المحددة بنجاح.",showConfirmButton:!1,timer:1500,buttonsStyling:!1})},error:function(n){console.error("Bulk delete error:",n),Swal.fire({title:"خطأ!",text:"حدث خطأ أثناء الحذف. حاول مرة أخرى.",type:"error",confirmButtonClass:"btn btn-primary",buttonsStyling:!1})}})})}),!window.papionInvData)console.warn("PapionInvData not found");else{const a=document.getElementById("inkChart");if(a&&typeof Chart<"u"){let e=function(m,p,u=null){const f=m.find(h=>h.machine_type===p&&(u?h.color===u:!0));return f?f.quantity:0},s=function(m,p){const u=m.createLinearGradient(100,75,100,300);return u.addColorStop(0,p),u.addColorStop(1,p+"80"),u};const t=a.getContext("2d"),n=window.papionInvData.inkStocks||[],l=document.getElementById("paperChart").getContext("2d"),i=window.papionInvData.paperStocks||[],r={cyan:"#00CFE8",magenta:"#EA5455",yellow:"#FF9F43",black:"#4B4B4B",white:"#E5E7EB",green:"#28C76F",orange:"#FF9F43"},w={labels:["Sub-C","Sub-M","Sub-Y","Sub-K","DTF-C","DTF-M","DTF-Y","DTF-K","DTF-W"],datasets:[{label:"Ink (L)",data:[e(n,"sublimation","Cyan"),e(n,"sublimation","Magenta"),e(n,"sublimation","Yellow"),e(n,"sublimation","Black"),e(n,"dtf","Cyan"),e(n,"dtf","Magenta"),e(n,"dtf","Yellow"),e(n,"dtf","Black"),e(n,"dtf","White")],backgroundColor:[s(t,r.cyan),s(t,r.magenta),s(t,r.yellow),s(t,r.black),s(t,r.cyan),s(t,r.magenta),s(t,r.yellow),s(t,r.black),r.white],borderColor:"transparent",borderWidth:0,borderRadius:4,elements:{bar:{borderRadius:4}}}]},C=new Chart(t,{type:"bar",data:w,options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,grid:{color:"#e7e7e7",drawBorder:!1},ticks:{stepSize:1,color:"#b9c3cd"}},x:{grid:{display:!1},ticks:{color:"#b9c3cd"}}},plugins:{legend:{display:!1}},animation:{duration:2e3,easing:"easeInOutQuart"}}}),S={labels:["Sublimation","DTF"],datasets:[{label:"Paper (Meters)",data:[e(i,"sublimation"),e(i,"dtf")],backgroundColor:[s(l,r.green),s(l,r.orange)],borderColor:"transparent",borderWidth:0,borderRadius:4,barThickness:50}]};new Chart(l,{type:"bar",data:S,options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,grid:{color:"#e7e7e7",drawBorder:!1},ticks:{color:"#b9c3cd"}},x:{grid:{display:!1},ticks:{color:"#b9c3cd"}}},plugins:{legend:{display:!1}},animation:{duration:2e3,easing:"easeInOutQuart"}}}),$(document).on("click",".consume-ink-btn",function(){let m=$(this).data("type"),p=$(this).data("color");Swal.fire({title:"تأكيد الاستهلاك",text:`هل أنت متأكد من خصم 1 لتر من ${p} (${m})؟`,type:"warning",showCancelButton:!0,confirmButtonText:"نعم، اخصم",cancelButtonText:"إلغاء"}).then(u=>{u.value&&$.ajax({url:window.papionInvData.consumeInkRoute,method:"POST",data:{_token:window.papionInvData.csrfToken,machine_type:m,color:p},success:function(f){Swal.fire("تم!",f.success,"success");let c={Cyan:0,Magenta:1,Yellow:2,Black:3,White:4}[p],g;m==="sublimation"?g=c:p==="White"?g=8:g=4+c,g!==void 0&&C.data.datasets[0]&&(C.data.datasets[0].data[g]=f.new_quantity,C.update())},error:function(f){let h=f.responseJSON?f.responseJSON.error:"حدث خطأ أثناء الخصم";Swal.fire("خطأ!",h,"error")}})})})}else console.log("Chart elements not found or Chart.js not loaded")}});
