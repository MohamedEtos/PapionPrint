$(document).ready(function(){var _=$(".steps-validation").show();$(document).on("input","#data-required-pieces, #data-pieces-per-card",function(){var a=parseFloat($("#data-required-pieces").val()),e=parseFloat($("#data-pieces-per-card").val());if(a>0&&e>0){var t=Math.ceil(a/e),r=$("#data-cards-count");r.val()!=t&&(r.val(t),r.removeClass("flash-input"),r.closest(".form-control").get(0).offsetWidth,r.addClass("flash-input"),setTimeout(function(){r.removeClass("flash-input")},1e3))}}),$(document).on("input","#data-customer-view",function(){var a=$(this).val(),e="",t=$("#customers-list option").filter(function(){return $(this).val()===a});t.length>0&&(e=t.attr("data-id")),$("#data-customer").val(e)}),$(".steps-validation").steps({headerTag:"h6",bodyTag:"fieldset",transitionEffect:"fade",titleTemplate:'<span class="step">#index#</span> #title#',labels:{finish:"Submit"},onStepChanging:function(a,e,t){return e>t?!0:(e<t&&(_.find(".body:eq("+t+") label.error").remove(),_.find(".body:eq("+t+") .error").removeClass("error")),_.validate().settings.ignore=":disabled,:hidden",_.valid())},onFinishing:function(a,e){return _.validate().settings.ignore=":disabled",_.valid()},onFinished:function(a,e){q()}}),$(".steps-validation").validate({ignore:"input[type=hidden]",errorClass:"danger",successClass:"success",highlight:function(a,e){$(a).removeClass(e)},unhighlight:function(a,e){$(a).removeClass(e)},errorPlacement:function(a,e){a.insertAfter(e)}});var z=$(".data-thumb-view").DataTable({responsive:!1,deferRender:!0,columnDefs:[{orderable:!0,targets:0,checkboxes:{selectRow:!0}}],dom:'<"top"<"actions action-btns"B><"action-filters"lf>><"clear">rt<"bottom"<"actions">p>',oLanguage:{sLengthMenu:"_MENU_",sSearch:""},aLengthMenu:[[4,10,15,20],[4,10,15,20]],select:{style:"multi"},order:[[1,"desc"]],bInfo:!1,pageLength:4,buttons:[{text:"<i class='feather icon-plus'></i> إضافة طلب جديد",action:function(a,e,t,r){$("#validation").slideToggle(function(){var o=$(this).is(":visible");e.button(t).text(o?'<i class="feather icon-x"></i> اغـــلاق':"<i class='feather icon-plus'></i> إضافة طلب جديد")})},className:"btn-outline-primary"}],initComplete:function(a,e){$(".dt-buttons .btn").removeClass("btn-secondary")}}),j=$(".actions-dropodown");j.insertBefore($(".top .actions .dt-buttons")),$(".data-items").length>0&&new PerfectScrollbar(".data-items",{wheelPropagation:!1}),$(".hide-data-sidebar, .cancel-data-btn, .overlay-bg").on("click",function(){$(".add-new-data").removeClass("show"),$(".overlay-bg").removeClass("show"),$("#data-name, #data-price").val(""),$("#data-category, #data-status").prop("selectedIndex",0)});var B=null;let k=1;$("#add-layer-btn").on("click",function(){var a=$("#layers-container .layer-row").first(),e=a.clone();e.find(".layer-size").attr("name","layers["+k+"][size]").val(""),e.find(".layer-count").attr("name","layers["+k+"][count]").val(""),$("#layers-container").append(e),k++}),$(document).on("click",".remove-layer-btn",function(){$("#layers-container .layer-row").length>1?$(this).closest(".layer-row").remove():$(this).closest(".layer-row").find("input, select").val("")}),$(document).on("paste",function(a){var e=(a.clipboardData||a.originalEvent.clipboardData).items;for(var t in e){var r=e[t];if(r.kind==="file"&&r.type.indexOf("image/")!==-1){var o=r.getAsFile(),p=new File([o],"pasted-image.png",{type:o.type});let l=new DataTransfer;l.items.add(p),$("#data-image-upload")[0].files=l.files;var s=new FileReader;s.onload=function(v){$("#pasted-image-preview img").attr("src",v.target.result),$("#pasted-image-preview").show()},s.readAsDataURL(o),toastr.success("Image pasted successfully!","Success")}}}),$("#data-image-upload").on("change",function(){if(this.files&&this.files[0]){var a=new FileReader;a.onload=function(e){$("#pasted-image-preview img").attr("src",e.target.result),$("#pasted-image-preview").show()},a.readAsDataURL(this.files[0])}});function q(){var a=new FormData,e=$("#data-customer").val(),t=$("#data-customer-view").val();if(!e&&t){var r=$("#customers-list option").filter(function(){return $(this).val()===t});r.length>0&&(e=r.attr("data-id"))}a.append("customerId",e||""),a.append("customer_name",t),a.append("height",$("#data-height").val()),a.append("width",$("#data-width").val()),a.append("cards_count",$("#data-cards-count").val()),a.append("pieces_per_card",$("#data-pieces-per-card").val()),a.append("machine_time",$("#data-machine-time").val());var o=parseFloat($("#data-height").val())||0,p=parseFloat($("#data-width").val())||0,s=parseFloat($("#data-cards-count").val())||0,l=parseFloat($("#data-pieces-per-card").val())||0,v=parseFloat($("#data-machine-time").val())||0,d={needle:{},paper:{},global:{},machine:0};window.tarterPrices&&window.tarterPrices.forEach(function(i){if(i.type==="needle")d.needle[i.size]=parseFloat(i.price)||0;else if(i.type==="paper"){var f=i.size.replace(/\D/g,"");f&&(d.paper[f]=parseFloat(i.price)||0)}else i.type==="global"&&i.size==="operating_cost"?d.global.op_cost=parseFloat(i.price)||0:i.type==="machine_time_cost"&&(d.machine=parseFloat(i.price)||0)});var m=Math.round(p),c=d.paper[m]||0,E=o/100*c,M=d.global.op_cost||0,C=0;$("#layers-container .layer-row").each(function(i,f){var b=$(f).find(".layer-size").val(),h=parseFloat($(f).find(".layer-count").val())||0;if(b&&h){var y=d.needle[b]||0;C+=h*y}});var n=E+M+C,u=n*s,g=v*d.machine,P=u+g,S=s*l,w=S>0?P/S:0;a.append("manufacturing_cost",w.toFixed(4)),a.append("notes",$("#data-notes").val()),$("#layers-container .layer-row").each(function(i,f){var b=$(f).find(".layer-size").val(),h=$(f).find(".layer-count").val();b&&h&&(a.append("layers["+i+"][size]",b),a.append("layers["+i+"][count]",h))}),a.append("_token",$('meta[name="csrf-token"]').attr("content"));var F=$("#data-image-upload")[0].files[0];F&&a.append("image",F);var T="/tarter/store",x="POST";B&&(T="/tarter/update/"+B,a.append("_method","PUT")),$.ajax({url:T,type:x,data:a,processData:!1,contentType:!1,success:function(i){console.log("Order saved:",i),Swal.fire({type:"success",title:"تم التسجيل بنجاح!",showConfirmButton:!1,timer:1500,buttonsStyling:!1,confirmButtonClass:"btn btn-primary"}),$("#validation").slideUp(),setTimeout(function(){location.reload()},1e3)},error:function(i){if(console.error("Error processing order:",i),i.status===422){var f=i.responseJSON.errors;$.each(f,function(b,h){toastr.error(h[0],"خطا")})}else toastr.error("Error processing order. Please try again.","خطا")}})}window.editTarter=function(a){B=a,$.get("/tarter/show/"+a,function(e){$(".new-data-title h4").text("تعديل طلب"),$("#saveDataBtn").text("Update"),$("#data-customer").val(e.customer_id),e.customer&&$("#data-customer-view").val(e.customer.name),$("#data-height").val(e.height);var t=!1;$("#data-width option").each(function(){if(this.value==e.width)return t=!0,!1}),!t&&e.width&&$("#data-width").append(new Option(e.width,e.width)),$("#data-width").val(e.width),$("#data-cards-count").val(e.cards_count),$("#data-pieces-per-card").val(e.pieces_per_card),$("#data-machine-time").val(e.machine_time),$("#data-notes").val(e.notes),e.cards_count&&e.pieces_per_card&&$("#data-required-pieces").val(e.cards_count*e.pieces_per_card),$("#layers-container").empty(),e.layers&&e.layers.length>0?(e.layers.forEach(function(r,o){var p=`<div class="layer-row row mb-1">
                                        <div class="col-md-5">
                                            <div class="form-group">
                                                <label>مقاس الإبرة</label>
                                                <select class="form-control layer-size" name="layers[${o}][size]">
                                                     // Options will be set below
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <div class="form-group">
                                                <label>العدد</label>
                                                <input type="number" class="form-control layer-count" name="layers[${o}][count]" placeholder="عدد الحبات" value="${r.count}">
                                            </div>
                                        </div>
                                        <div class="col-md-2 d-flex align-items-center">
                                            <button type="button" class="btn btn-danger btn-icon remove-layer-btn"><i class="feather icon-trash"></i></button>
                                        </div>
                                    </div>`,s=$(p),l="",v=!1,d=String(r.size).trim();window.tarterPrices&&window.tarterPrices.forEach(function(m){m.type==="needle"&&(l+=`<option value="${m.size}">${m.size}</option>`,String(m.size).trim()==d&&(v=!0))}),!v&&r.size&&(l+=`<option value="${r.size}">${r.size}</option>`),l===""&&(l='<option value="9">9</option><option value="11">11</option><option value="14">14</option>'),s.find(".layer-size").html(l).val(r.size),$("#layers-container").append(s)}),k=e.layers.length):$("#add-layer-btn").trigger("click"),$("#validation").slideDown(),$("html, body").animate({scrollTop:$("#validation").offset().top},500)})},window.deleteTarter=function(a){Swal.fire({title:"هل انت متأكد؟",text:"لن تتمكن من استرجاع هذا الطلب!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"نعم، احذفه!",cancelButtonText:"الغاء"}).then(e=>{e.value&&$.ajax({url:"/tarter/delete/"+a,type:"DELETE",data:{_token:$('meta[name="csrf-token"]').attr("content")},success:function(t){Swal.fire("تم الحذف!","تم حذف الطلب بنجاح.","success").then(()=>{location.reload()})},error:function(t){Swal.fire("خطأ!","حدث خطأ اثناء الحذف.","error")}})})},window.restartTarter=function(a){Swal.fire({title:"إعادة تشغيل؟",text:"سيتم إنشاء نسخة جديدة من هذا الطلب.",type:"question",showCancelButton:!0,confirmButtonText:"نعم، أعد التشغيل",cancelButtonText:"الغاء"}).then(e=>{e.value&&$.ajax({url:"/tarter/restart/"+a,type:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content")},success:function(t){Swal.fire("تم!","تم إعادة تشغيل الطلب بنجاح.","success").then(()=>{location.reload()})},error:function(t){Swal.fire("خطأ!","حدث خطأ اثناء العملية.","error")}})})},z.on("select deselect",function(){var a=z.rows({selected:!0}).count();a>0&&$(".action-btns").show(),I()}),$("#bulk-delete-btn").on("click",function(){var a=z.rows({selected:!0}).nodes(),e=[];$.each(a,function(t,r){var o=$(r).find(".tarter_id").val();o&&e.push(o)}),e.length!==0&&Swal.fire({title:"هل انت متأكد؟",text:"سيتم حذف "+e.length+" طلب/طلبات ولن تستطيع استرجاعهم!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"نعم، احذف",cancelButtonText:"الغاء"}).then(t=>{t.value&&$.ajax({url:"/tarter/bulk-delete",type:"POST",data:{ids:e,_token:$('meta[name="csrf-token"]').attr("content")},success:function(r){Swal.fire("تم الحذف!","تم حذف الطلبات المحددة بنجاح.","success").then(()=>{location.reload()})},error:function(r){Swal.fire("خطأ!","حدث خطأ اثناء الحذف.","error")}})})});function I(){var a={},e=0,t=0,r=0,o=0,p=0,s={needle:{},paper:{},global:{},machine:0};window.tarterPrices&&window.tarterPrices.forEach(function(n){if(n.type==="needle")s.needle[n.size]=parseFloat(n.price)||0;else if(n.type==="paper"){var u=n.size.replace(/\D/g,"");u&&(s.paper[u]=parseFloat(n.price)||0)}else n.type==="global"&&n.size==="operating_cost"?s.global.op_cost=parseFloat(n.price)||0:n.type==="machine_time_cost"&&(s.machine=parseFloat(n.price)||0)});function l(n){var u=Math.round(n);return s.paper[u]?s.paper[u]:0}var v=z.rows({selected:!0}).nodes(),d=v.length>0;$.each(v,function(n,u){var g=$(u),P=parseFloat(g.data("height"))||0,S=parseFloat(g.data("width"))||0,w=parseFloat(g.data("cards-count"))||0,F=parseFloat(g.data("pieces-per-card"))||0,T=parseFloat(g.data("machine-time"))||0;w>0&&(e+=P*w/100),w>0&&F>0&&(t+=w*F),r+=T;var x=0,i=l(S),f=P/100*i;x+=f;var b=s.global.op_cost||0;x+=b;var h=T*s.machine,y=g.data("layers");if(y){if(typeof y=="string")try{y=JSON.parse(y)}catch{}$.each(y,function(U,R){var D=R.size,O=parseFloat(R.count)||0;a[D]||(a[D]=0),a[D]+=O;var N=s.needle[D]||0;x+=O*N})}var L=x*w+h;p+=L,o+=w});var m=$("#tarter-calculator-results");if(d){var c="";if(e>0&&(c+='<span class="badge badge-info mb-1" style="font-size: 1em; margin-left:15px;"><i class="feather icon-maximize-2"></i>  طول الورق : '+e.toFixed(2)+" متر</span>"),t>0&&(c+='<span class="badge badge-warning mb-1" style="font-size: 1em; margin-left:15px;"><i class="feather icon-package"></i> اجمالي القطع : '+t+" </span>"),r>0&&(c+='<span class="badge badge-danger mb-1" style="font-size: 1em; margin-left:15px;"><i class="feather icon-clock"></i> وقت الماكينة : '+r+" دقيقة</span>"),p>0)if(c+='<span class="badge badge-primary mb-1" style="font-size: 1em; margin-left:15px;"><i class="feather icon-dollar-sign"></i> الاجمالي : '+p.toFixed(2)+" جنيه</span>",o>0){var E=p/o;if(c+='<span class="badge badge-purple mb-1" style="font-size: 1em; margin-left:15px; background-color: #6f42c1; color:white;"><i class="feather icon-tag"></i> تكلفة الكارت : '+E.toFixed(3)+" جنيه</span>",t>0){var M=p/t;c+='<span class="badge badge-warning mb-1" style="font-size: 1em; margin-left:15px; background-color: #ff9f43; color:white;"><i class="feather icon-disc"></i> تكلفة القطعة : '+M.toFixed(4)+" جنيه</span>"}c+="<br>"}else c+="<br>";else(e>0||t>0)&&(c+="<br>");c+='<i class="feather icon-bar-chart-2"></i> اجمالي الترتر: &nbsp;&nbsp;';var C=[];Object.keys(a).sort((n,u)=>n-u).forEach(function(n){C.push('<span class="badge badge-success" style="font-size: 1em; margin-left:5px;"> مقاس '+n+": "+a[n]+" </span>")}),C.length===0?c+="لا توجد طبقات محددة":c+=C.join(" "),m.html(c).slideDown()}else m.slideUp()}window.addToInvoice=function(){var a=z.rows({selected:!0}).nodes(),e=[];if($.each(a,function(t,r){var o=$(r).find(".tarter_id").val();o&&e.push(o)}),e.length===0){toastr.warning("Please select items first");return}$.post("/invoices/add",{_token:$('meta[name="csrf-token"]').attr("content"),ids:e,type:"tarter"},function(t){toastr.success("تمت الاضافة للفاتورة"),t.cart_count!==void 0&&($(".cart-item-count").text(t.cart_count),$(".badge.badge-up.cart-item-count").text(t.cart_count)),t.cart_html&&$("#cart-dropdown-items").html(t.cart_html)}).fail(function(){toastr.error("حدث خطأ")})},$(document).on("click",".product-img img",function(){var a=$(this).attr("src");a&&($("#enlarged-image").attr("src",a),$("#imageZoomModal").modal("show"))}),$(".close-zoom").on("click",function(){$("#imageZoomModal").modal("hide")})});
